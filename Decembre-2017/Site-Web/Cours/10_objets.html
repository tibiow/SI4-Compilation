<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="author" content="Erick Gallesio" />
    <meta name="robots" content="noindex, nofollow, noarchive" />
    <meta name="robots" content="none" />
    <meta name="generator" content="Gomd 2.0-alpha / Erick Gallesio" />
    
    <!-- Slidy stuff -->
    <meta name="copyright" content="Langages Formels et Automates -- 2017-2018" />
    
    <meta name="font-size-adjustment" content="-2" />
    <style>
      <!-- body{margin:0;padding:0;width:1e2%;height:1e2%;color:#000;background-color:#fff;font-family:gill sans mt,gill sans,gillsans,sans-serif;font-size:14pt}div.toolbar{position:fixed;z-index:200;top:auto;bottom:0;left:0;right:0;height:1.2em;text-align:right;padding-left:1em;padding-right:1em;font-size:60%;color:red;background-color:#f0f0f0;border-top:solid 1px #b4b4b4}div.toolbar span.copyright{color:#000;margin-left:.5em}div.initial_prompt{position:absolute;z-index:1000;bottom:1.2em;width:1e2%;background-color:rgb(2e2,2e2,2e2);opacity:.35;background-color:rgb(2e2,2e2,2e2,.35);cursor:pointer}div.initial_prompt p.help{text-align:center}div.initial_prompt p.close{text-align:right;font-style:italic}div.slidy_toc{position:absolute;z-index:300;width:60%;max-width:30em;height:30em;overflow:auto;top:auto;right:auto;left:4em;bottom:4em;padding:1em;background:#f0f0f0;border-style:solid;border-width:2px;font-size:60%}div.slidy_toc .toc_heading{text-align:center;width:1e2%;margin:0;margin-bottom:1em;border-bottom-style:solid;border-bottom-color:#b4b4b4;border-bottom-width:1px}div.slide{z-index:20;margin:0;padding-top:0;padding-bottom:0;padding-left:20px;padding-right:20px;border-width:0;clear:both;top:0;bottom:0;left:0;right:0;line-height:120%;background-color:transparent}div.background{display:none}div.handout{margin-left:20px;margin-right:20px}div.slide.titlepage{text-align:center}div.slide.titlepage h1{padding-top:10%;margin-right:0;background:red}div.slide h1{padding-left:0;padding-right:20pt;padding-top:4pt;padding-bottom:4pt;margin-top:0;margin-left:0;margin-right:60pt;margin-bottom:.5em;display:block;font-size:160%;line-height:1.2em;background:transparent}@media screen and (max-device-width:1024px){div.slide{font-size:1e2%}}@media screen and (max-device-width:800px){div.slide{font-size:2e2%}div.slidy_toc{top:1em;left:1em;right:auto;width:80%;font-size:180%}}div.toc-heading{width:1e2%;border-bottom:solid 1px #b4b4b4;margin-bottom:1em;text-align:center}img{image-rendering:optimize-quality}pre{font-size:80%;font-weight:700;line-height:120%}li pre{margin-left:0}blockquote{font-style:italic}img{background-color:transparent}p.copyright{font-size:smaller}.center{text-align:center}.footnote{font-size:smaller;margin-left:2em}a img{border-width:0;border-style:none}a:visited{color:navy}a:link{color:navy}a:hover{color:red;text-decoration:underline}a:active{color:red;text-decoration:underline}a{text-decoration:none}.toolbar a:link{color:blue}.toolbar a:visited{color:blue}.toolbar a:active{color:red}.toolbar a:hover{color:red}ul{list-style-type:square}ul ul{list-style-type:disc}ul ul ul{list-style-type:circle}ul ul ul ul{list-style-type:disc}li{margin-left:.5em;margin-top:.5em}li li{font-size:85%;font-style:italic}li li li{font-size:85%;font-style:normal}div dt{margin-left:0;margin-top:1em;margin-bottom:.5em;font-weight:700}div dd{margin-left:2em;margin-bottom:.5em}p,pre,ul,ol,blockquote,h2,h3,h4,h5,h6,dl,table{margin-left:1em;margin-right:1em}p.subhead{font-weight:700;margin-top:2em}.smaller{font-size:smaller}.bigger{font-size:130%}td,th{padding:.2em}ul{margin:.5em 1.5em;padding:0}ol{margin:.5em 1.5em;padding:0}ul{list-style-type:square}ul ul{list-style-type:disc}ul ul ul{list-style-type:circle}ul ul ul ul{list-style-type:disc}ul li{list-style:square;margin:.1em 0 .6em;padding:0;line-height:140%}ol li{margin:.1em 0 .6em 1.5em;padding:0;line-height:140%;list-style-type:decimal}li ul li{font-size:85%;font-style:italic;list-style-type:disc;background:transparent;padding:0}li li ul li{font-size:85%;font-style:normal;list-style-type:circle;background:transparent;padding:0}li li li ul li{list-style-type:disc;background:transparent;padding:0}li ol li{list-style-type:decimal}li li ol li{list-style-type:decimal}ol.outline li:hover{cursor:pointer}ol.outline li.nofold:hover{cursor:default}ul.outline li:hover{cursor:pointer}ul.outline li.nofold:hover{cursor:default}ol.outline{list-style:decimal}ol.outline ol{list-style-type:lower-alpha}ol.outline li.nofold{padding:0 0 0 20px;background:transparent url(../graphics/nofold-dim.gif) no-repeat 0 .5em}ol.outline li.unfolded{padding:0 0 0 20px;background:transparent url(../graphics/fold-dim.gif) no-repeat 0 .5em}ol.outline li.folded{padding:0 0 0 20px;background:transparent url(../graphics/unfold-dim.gif) no-repeat 0 .5em}ol.outline li.unfolded:hover{padding:0 0 0 20px;background:transparent url(../graphics/fold.gif) no-repeat 0 .5em}ol.outline li.folded:hover{padding:0 0 0 20px;background:transparent url(../graphics/unfold.gif) no-repeat 0 .5em}ul.outline li.nofold{padding:0 0 0 20px;background:transparent url(../graphics/nofold-dim.gif) no-repeat 0 .5em}ul.outline li.unfolded{padding:0 0 0 20px;background:transparent url(../graphics/fold-dim.gif) no-repeat 0 .5em}ul.outline li.folded{padding:0 0 0 20px;background:transparent url(../graphics/unfold-dim.gif) no-repeat 0 .5em}ul.outline li.unfolded:hover{padding:0 0 0 20px;background:transparent url(../graphics/fold.gif) no-repeat 0 .5em}ul.outline li.folded:hover{padding:0 0 0 20px;background:transparent url(../graphics/unfold.gif) no-repeat 0 .5em}a.titleslide{font-weight:700;font-style:italic}img.hidden{display:none;visibility:hidden}div.initial_prompt{display:none;visibility:hidden}div.slide{visibility:visible;position:inherit}div.handout{border-top-style:solid;border-top-width:thin;border-top-color:#000}@media screen{.hidden{display:none;visibility:visible}div.slide.hidden{display:block;visibility:visible}div.handout.hidden{display:block;visibility:visible}div.background{display:none;visibility:hidden}body.single_slide div.initial_prompt{display:block;visibility:visible}body.single_slide div.background{display:block;visibility:visible}body.single_slide div.background.hidden{display:none;visibility:hidden}body.single_slide .invisible{visibility:hidden}body.single_slide .hidden{display:none;visibility:hidden}body.single_slide div.slide{position:absolute}body.single_slide div.handout{display:none;visibility:hidden}}@media print{.hidden{display:block;visibility:visible}div.slide pre{font-size:60%;padding-left:.5em}div.toolbar{display:none;visibility:hidden}div.slidy_toc{display:none;visibility:hidden}div.background{display:none;visibility:hidden}div.slide{page-break-before:always}div.slide.first-slide{page-break-before:avoid}} -->
    </style>
    <script>var w3c_slidy={ns_pos:(typeof window.pageYOffset!='undefined'),khtml:((navigator.userAgent).indexOf("KHTML")>=0?true:false),opera:((navigator.userAgent).indexOf("Opera")>=0?true:false),ipad:((navigator.userAgent).indexOf("iPad")>=0?true:false),iphone:((navigator.userAgent).indexOf("iPhone")>=0?true:false),android:((navigator.userAgent).indexOf("Android")>=0?true:false),ie:(typeof document.all!="undefined"&&!this.opera),ie6:(!this.ns_pos&&navigator.userAgent.indexOf("MSIE 6")!=-1),ie7:(!this.ns_pos&&navigator.userAgent.indexOf("MSIE 7")!=-1),ie8:(!this.ns_pos&&navigator.userAgent.indexOf("MSIE 8")!=-1),ie9:(!this.ns_pos&&navigator.userAgent.indexOf("MSIE 9")!=-1),last_tap:0,prev_tap:0,start_x:0,start_y:0,delta_x:0,delta_y:0,is_xhtml:/xml/.test(document.contentType),slide_number:0,slide_number_element:null,slides:[],notes:[],backgrounds:[],observers:[],toolbar:null,title:null,last_shown:null,eos:null,toc:null,outline:null,selected_text_len:0,view_all:0,want_toolbar:true,mouse_click_enabled:false,scroll_hack:0,disable_slide_click:false,lang:"en",help_anchor:null,help_page:"http://www.w3.org/Talks/Tools/Slidy2/help/help.html",help_text:"Navigate with mouse click, space bar, Cursor Left/Right, "+"or Pg Up and Pg Dn. Use S and B to change font size.",size_index:0,size_adjustment:0,sizes:new Array("10pt","12pt","14pt","16pt","18pt","20pt","22pt","24pt","26pt","28pt","30pt","32pt"),last_width:0,last_height:0,objects:[],set_up:function(){var init=function(){w3c_slidy.init();};if(typeof window.addEventListener!="undefined")
window.addEventListener("load",init,false);else
window.attachEvent("onload",init);},hide_slides:function(){if(document.body&&!w3c_slidy.initialized)
document.body.style.visibility="hidden";else
setTimeout(w3c_slidy.hide_slides,50);},ie_hack:function(){window.resizeBy(0,-1);window.resizeBy(0,1);},init:function(){document.body.style.visibility="visible";this.init_localization();this.add_toolbar();this.wrap_implicit_slides();this.collect_slides();this.collect_notes();this.collect_backgrounds();this.objects=document.body.getElementsByTagName("object");this.patch_anchors();this.slide_number=this.find_slide_number(location.href);window.offscreenbuffering=true;this.size_adjustment=this.find_size_adjust();this.time_left=this.find_duration();this.hide_image_toolbar();this.init_outliner();this.title=document.title;this.keyboardless=(this.ipad||this.iphone||this.android);if(this.keyboardless)
{w3c_slidy.remove_class(w3c_slidy.toolbar,"hidden")
this.want_toolbar=0;}
this.is_xhtml=(document.body.tagName=="BODY"?false:true);if(this.slides.length>0)
{var slide=this.slides[this.slide_number];if(this.slide_number>0)
{this.set_visibility_all_incremental("visible");this.last_shown=this.previous_incremental_item(null);this.set_eos_status(true);}
else
{this.last_shown=null;this.set_visibility_all_incremental("hidden");this.set_eos_status(!this.next_incremental_item(this.last_shown));}
this.set_location();this.add_class(this.slides[0],"first-slide");w3c_slidy.show_slide(slide);}
this.toc=this.table_of_contents();if(!this.keyboardless)
{this.add_listener(document.body,"click",this.mouse_button_click);this.add_listener(document.body,"mousedown",this.mouse_button_down);}
this.add_listener(document,"keydown",this.key_down);this.add_listener(document,"keypress",this.key_press);this.add_listener(window,"resize",this.resized);this.add_listener(window,"scroll",this.scrolled);this.add_listener(window,"unload",this.unloaded);this.add_listener(document,"gesturechange",function()
{return false;});this.attach_touch_handers(this.slides);this.single_slide_view();this.resized();if(this.ie7)
setTimeout(w3c_slidy.ie_hack,100);this.show_toolbar();setInterval(function(){w3c_slidy.check_location();},200);w3c_slidy.initialized=true;},table_of_contents:function(){var toc=this.create_element("div");this.add_class(toc,"slidy_toc hidden");var heading=this.create_element("div");this.add_class(heading,"toc-heading");heading.innerHTML=this.localize("Table of Contents");toc.appendChild(heading);var previous=null;for(var i=0;i<this.slides.length;++i)
{var title=this.has_class(this.slides[i],"title");var num=document.createTextNode((i+1)+". ");toc.appendChild(num);var a=this.create_element("a");a.setAttribute("href","#("+(i+1)+")");if(title)
this.add_class(a,"titleslide");var name=document.createTextNode(this.slide_name(i));a.appendChild(name);a.onclick=w3c_slidy.toc_click;a.onkeydown=w3c_slidy.toc_key_down;a.previous=previous;if(previous)
previous.next=a;toc.appendChild(a);if(i==0)
toc.first=a;if(i<this.slides.length-1)
{var br=this.create_element("br");toc.appendChild(br);}
previous=a;}
toc.focus=function(){if(this.first)
this.first.focus();}
toc.onmouseup=w3c_slidy.mouse_button_up;toc.onclick=function(e){e||(e=window.event);if(w3c_slidy.selected_text_len<=0)
w3c_slidy.hide_table_of_contents(true);w3c_slidy.stop_propagation(e);if(e.cancel!=undefined)
e.cancel=true;if(e.returnValue!=undefined)
e.returnValue=false;return false;};document.body.insertBefore(toc,document.body.firstChild);return toc;},is_shown_toc:function(){return!w3c_slidy.has_class(w3c_slidy.toc,"hidden");},show_table_of_contents:function(){w3c_slidy.remove_class(w3c_slidy.toc,"hidden");var toc=w3c_slidy.toc;toc.focus();if(w3c_slidy.ie7&&w3c_slidy.slide_number==0)
setTimeout(w3c_slidy.ie_hack,100);},hide_table_of_contents:function(focus){w3c_slidy.add_class(w3c_slidy.toc,"hidden");if(focus&&!w3c_slidy.opera&&!w3c_slidy.has_class(w3c_slidy.toc,"hidden"))
w3c_slidy.set_focus();},toggle_table_of_contents:function(){if(w3c_slidy.is_shown_toc())
w3c_slidy.hide_table_of_contents(true);else
w3c_slidy.show_table_of_contents();},toc_click:function(e){if(!e)
e=window.event;var target=w3c_slidy.get_target(e);if(target&&target.nodeType==1)
{var uri=target.getAttribute("href");if(uri)
{var slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.slide_number=w3c_slidy.find_slide_number(uri);slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.last_shown=null;w3c_slidy.set_location();w3c_slidy.set_visibility_all_incremental("hidden");w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));w3c_slidy.show_slide(slide);try
{if(!w3c_slidy.opera)
w3c_slidy.set_focus();}
catch(e)
{}}}
w3c_slidy.hide_table_of_contents(true);if(w3c_slidy.ie7)w3c_slidy.ie_hack();w3c_slidy.stop_propagation(e);return w3c_slidy.cancel(e);},toc_key_down:function(event){var key;if(!event)
var event=window.event;if(window.event)
key=window.event.keyCode;else if(event.which)
key=event.which;else
return true;if(!key)
return true;if(event.ctrlKey||event.altKey)
return true;if(key==13)
{var uri=this.getAttribute("href");if(uri)
{var slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.slide_number=w3c_slidy.find_slide_number(uri);slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.last_shown=null;w3c_slidy.set_location();w3c_slidy.set_visibility_all_incremental("hidden");w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));w3c_slidy.show_slide(slide);try
{if(!w3c_slidy.opera)
w3c_slidy.set_focus();}
catch(e)
{}}
w3c_slidy.hide_table_of_contents(true);if(self.ie7)
w3c_slidy.ie_hack();return w3c_slidy.cancel(event);}
if(key==40&&this.next)
{this.next.focus();return w3c_slidy.cancel(event);}
if(key==38&&this.previous)
{this.previous.focus();return w3c_slidy.cancel(event);}
return true;},touchstart:function(e)
{this.prev_tap=this.last_tap;this.last_tap=(new Date).getTime();var tap_delay=this.last_tap-this.prev_tap;if(tap_delay<=200)
{}
var touch=e.touches[0];this.pageX=touch.pageX;this.pageY=touch.pageY;this.screenX=touch.screenX;this.screenY=touch.screenY;this.clientX=touch.clientX;this.clientY=touch.clientY;this.delta_x=this.delta_y=0;},touchmove:function(e)
{if(e.touches.length>1)
return;e.preventDefault();var touch=e.touches[0];this.delta_x=touch.pageX-this.pageX;this.delta_y=touch.pageY-this.pageY;},touchend:function(e)
{if(e.touches.length>1)
return;var delay=(new Date).getTime()-this.last_tap;var dx=this.delta_x;var dy=this.delta_y;var abs_dx=Math.abs(dx);var abs_dy=Math.abs(dy);if(delay<500&&(abs_dx>100||abs_dy>100))
{if(abs_dx>0.5*abs_dy)
{e.preventDefault();if(dx<0)
w3c_slidy.next_slide(true);else
w3c_slidy.previous_slide(true);}
else if(abs_dy>2*abs_dx)
{e.preventDefault();w3c_slidy.toggle_table_of_contents();}}},before_print:function(){this.show_all_slides();this.hide_toolbar();alert("before print");},after_print:function(){if(!this.view_all)
{this.single_slide_view();this.show_toolbar();}
alert("after print");},print_slides:function(){this.before_print();window.print();this.after_print();},toggle_view:function(){if(this.view_all)
{this.single_slide_view();this.show_toolbar();this.view_all=0;}
else
{this.show_all_slides();this.hide_toolbar();this.view_all=1;}},show_all_slides:function(){this.remove_class(document.body,"single_slide");this.set_visibility_all_incremental("visible");},single_slide_view:function(){this.add_class(document.body,"single_slide");this.set_visibility_all_incremental("visible");this.last_shown=this.previous_incremental_item(null);},hide_image_toolbar:function(){if(!this.ns_pos)
{var images=document.getElementsByTagName("IMG");for(var i=0;i<images.length;++i)
images[i].setAttribute("galleryimg","no");}},unloaded:function(e){},is_KHTML:function(){var agent=navigator.userAgent;return(agent.indexOf("KHTML")>=0?true:false);},slide_name:function(index){var name=null;var slide=this.slides[index];var heading=this.find_heading(slide);if(heading)
name=this.extract_text(heading);if(!name)
name=this.title+"("+(index+1)+")";name.replace(/\&/g,"&amp;");name.replace(/\</g,"&lt;");name.replace(/\>/g,"&gt;");return name;},find_heading:function(node){if(!node||node.nodeType!=1)
return null;if(node.nodeName=="H1"||node.nodeName=="h1")
return node;var child=node.firstChild;while(child)
{node=this.find_heading(child);if(node)
return node;child=child.nextSibling;}
return null;},extract_text:function(node){if(!node)
return"";if(node.nodeType==3)
return node.nodeValue;if(node.nodeType==1)
{node=node.firstChild;var text="";while(node)
{text=text+this.extract_text(node);node=node.nextSibling;}
return text;}
return"";},find_copyright:function(){var name,content;var meta=document.getElementsByTagName("meta");for(var i=0;i<meta.length;++i)
{name=meta[i].getAttribute("name");content=meta[i].getAttribute("content");if(name=="copyright")
return content;}
return null;},find_size_adjust:function(){var name,content,offset;var meta=document.getElementsByTagName("meta");for(var i=0;i<meta.length;++i)
{name=meta[i].getAttribute("name");content=meta[i].getAttribute("content");if(name=="font-size-adjustment")
return 1*content;}
return 1;},find_duration:function(){var name,content,offset;var meta=document.getElementsByTagName("meta");for(var i=0;i<meta.length;++i)
{name=meta[i].getAttribute("name");content=meta[i].getAttribute("content");if(name=="duration")
return 60000*content;}
return null;},replace_by_non_breaking_space:function(str){for(var i=0;i<str.length;++i)
str[i]=160;},init_outliner:function(){var items=document.getElementsByTagName("li");for(var i=0;i<items.length;++i)
{var target=items[i];if(!this.has_class(target.parentNode,"outline"))
continue;target.onclick=this.outline_click;if(this.foldable(target))
{target.foldable=true;target.onfocus=function(){w3c_slidy.outline=this;};target.onblur=function(){w3c_slidy.outline=null;};if(!target.getAttribute("tabindex"))
target.setAttribute("tabindex","0");if(this.has_class(target,"expand"))
this.unfold(target);else
this.fold(target);}
else
{this.add_class(target,"nofold");target.visible=true;target.foldable=false;}}},foldable:function(item){if(!item||item.nodeType!=1)
return false;var node=item.firstChild;while(node)
{if(node.nodeType==1&&this.is_block(node))
return true;node=node.nextSibling;}
return false;},fold:function(item){if(item)
{this.remove_class(item,"unfolded");this.add_class(item,"folded");}
var node=item?item.firstChild:null;while(node)
{if(node.nodeType==1&&this.is_block(node))
{w3c_slidy.add_class(node,"hidden");}
node=node.nextSibling;}
item.visible=false;},unfold:function(item){if(item)
{this.add_class(item,"unfolded");this.remove_class(item,"folded");}
var node=item?item.firstChild:null;while(node)
{if(node.nodeType==1&&this.is_block(node))
{w3c_slidy.remove_class(node,"hidden");}
node=node.nextSibling;}
item.visible=true;},outline_click:function(e){if(!e)
e=window.event;var rightclick=false;var target=w3c_slidy.get_target(e);while(target&&target.visible==undefined)
target=target.parentNode;if(!target)
return true;if(e.which)
rightclick=(e.which==3);else if(e.button)
rightclick=(e.button==2);if(!rightclick&&target.visible!=undefined)
{if(target.foldable)
{if(target.visible)
w3c_slidy.fold(target);else
w3c_slidy.unfold(target);}
w3c_slidy.stop_propagation(e);e.cancel=true;e.returnValue=false;}
return false;},add_toolbar:function(){var counter,page;this.toolbar=this.create_element("div");this.toolbar.setAttribute("class","toolbar");if(this.ns_pos||!this.ie6)
{var right=this.create_element("div");right.setAttribute("style","float: right; text-align: right");counter=this.create_element("span")
counter.innerHTML=this.localize("slide")+" n/m";right.appendChild(counter);this.toolbar.appendChild(right);var left=this.create_element("div");left.setAttribute("style","text-align: left");this.eos=this.create_element("span");this.eos.innerHTML="* ";left.appendChild(this.eos);var copyright=this.find_copyright();if(copyright)
{var span=this.create_element("span");span.className="copyright";span.innerHTML=copyright;left.appendChild(span);}
this.toolbar.setAttribute("tabindex","0");this.toolbar.appendChild(left);}
else
{this.toolbar.style.position=(this.ie7?"fixed":"absolute");this.toolbar.style.zIndex="200";this.toolbar.style.width="99.9%";this.toolbar.style.height="1.2em";this.toolbar.style.top="auto";this.toolbar.style.bottom="0";this.toolbar.style.left="0";this.toolbar.style.right="0";this.toolbar.style.textAlign="left";this.toolbar.style.fontSize="60%";this.toolbar.style.color="red";this.toolbar.borderWidth=0;this.toolbar.className="toolbar";this.toolbar.style.background="rgb(240,240,240)";var sp=this.create_element("span");sp.innerHTML="&nbsp;&nbsp;*&nbsp;";this.toolbar.appendChild(sp);this.eos=sp;var help=this.create_element("a");help.setAttribute("href",this.help_page);help.setAttribute("title",this.localize(this.help_text));help.innerHTML=this.localize("help?");this.toolbar.appendChild(help);this.help_anchor=help;var gap1=document.createTextNode(" ");this.toolbar.appendChild(gap1);var contents=this.create_element("a");contents.setAttribute("href","javascript:toggleTableOfContents()");contents.setAttribute("title",this.localize("table of contents".localize));contents.innerHTML=this.localize("contents?");this.toolbar.appendChild(contents);var gap2=document.createTextNode(" ");this.toolbar.appendChild(gap2);var copyright=this.find_copyright();if(copyright)
{var span=this.create_element("span");span.innerHTML=copyright;span.style.color="black";span.style.marginLeft="0.5em";this.toolbar.appendChild(span);}
counter=this.create_element("div")
counter.style.position="absolute";counter.style.width="auto";counter.style.height="1.2em";counter.style.top="auto";counter.style.bottom=0;counter.style.right="0";counter.style.textAlign="right";counter.style.color="red";counter.style.background="rgb(240,240,240)";counter.innerHTML=this.localize("slide")+" n/m";this.toolbar.appendChild(counter);}
this.toolbar.onclick=function(e){if(!e)
e=window.event;var target=e.target;if(!target&&e.srcElement)
target=e.srcElement;if(target&&target.nodeType==3)
target=target.parentNode;w3c_slidy.stop_propagation(e);if(target&&target.nodeName.toLowerCase()!="a")
w3c_slidy.mouse_button_click(e);};this.slide_number_element=counter;this.set_eos_status(false);document.body.appendChild(this.toolbar);},wrap_implicit_slides:function(){var i,heading,node,next,div;var headings=document.getElementsByTagName("h1");if(!headings)
return;for(i=0;i<headings.length;++i)
{heading=headings[i];if(heading.parentNode!=document.body)
continue;node=heading.nextSibling;div=document.createElement("div");this.add_class(div,"slide");document.body.replaceChild(div,heading);div.appendChild(heading);while(node)
{if(node.nodeType==1)
{if(node.nodeName=="H1"||node.nodeName=="h1")
break;if(node.nodeName=="DIV"||node.nodeName=="div")
{if(this.has_class(node,"slide"))
break;if(this.has_class(node,"handout"))
break;}}
next=node.nextSibling;node=document.body.removeChild(node);div.appendChild(node);node=next;}}},attach_touch_handers:function(slides)
{var i,slide;for(i=0;i<slides.length;++i)
{slide=slides[i];this.add_listener(slide,"touchstart",this.touchstart);this.add_listener(slide,"touchmove",this.touchmove);this.add_listener(slide,"touchend",this.touchend);}},collect_slides:function(){var slides=new Array();var divs=document.body.getElementsByTagName("div");for(var i=0;i<divs.length;++i)
{div=divs.item(i);if(this.has_class(div,"slide"))
{slides[slides.length]=div;this.add_class(div,"hidden");var node1=document.createElement("br");div.appendChild(node1);var node2=document.createElement("br");div.appendChild(node2);}
else if(this.has_class(div,"background"))
{div.style.display="block";}}
this.slides=slides;},collect_notes:function(){var notes=new Array();var divs=document.body.getElementsByTagName("div");for(var i=0;i<divs.length;++i)
{div=divs.item(i);if(this.has_class(div,"handout"))
{notes[notes.length]=div;this.add_class(div,"hidden");}}
this.notes=notes;},collect_backgrounds:function(){var backgrounds=new Array();var divs=document.body.getElementsByTagName("div");for(var i=0;i<divs.length;++i)
{div=divs.item(i);if(this.has_class(div,"background"))
{backgrounds[backgrounds.length]=div;this.add_class(div,"hidden");}}
this.backgrounds=backgrounds;},patch_anchors:function(){var self=w3c_slidy;var handler=function(event){if(self.page_address(this.href)==self.page_address(location.href))
{var newslidenum=self.find_slide_number(this.href);if(newslidenum!=self.slide_number)
{var slide=self.slides[self.slide_number];self.hide_slide(slide);self.slide_number=newslidenum;slide=self.slides[self.slide_number];self.show_slide(slide);self.set_location();}}
else
w3c_slidy.stop_propagation(event);this.blur();self.disable_slide_click=true;};var anchors=document.body.getElementsByTagName("a");for(var i=0;i<anchors.length;++i)
{if(window.addEventListener)
anchors[i].addEventListener("click",handler,false);else
anchors[i].attachEvent("onclick",handler);}},show_slide_number:function(){var timer=w3c_slidy.get_timer();w3c_slidy.slide_number_element.innerHTML=timer+w3c_slidy.localize("slide")+" "+
(w3c_slidy.slide_number+1)+"/"+w3c_slidy.slides.length;},check_location:function(){var hash=location.hash;if(w3c_slidy.slide_number>0&&(hash==""||hash=="#"))
w3c_slidy.goto_slide(0);else if(hash.length>2&&hash!="#("+(w3c_slidy.slide_number+1)+")")
{var num=parseInt(location.hash.substr(2));if(!isNaN(num))
w3c_slidy.goto_slide(num-1);}
if(w3c_slidy.time_left&&w3c_slidy.slide_number>0)
{w3c_slidy.show_slide_number();if(w3c_slidy.time_left>0)
w3c_slidy.time_left-=200;}},get_timer:function(){var timer="";if(w3c_slidy.time_left)
{var mins,secs;secs=Math.floor(w3c_slidy.time_left/1000);mins=Math.floor(secs/60);secs=secs%60;timer=(mins?mins+"m":"")+secs+"s ";}
return timer;},set_location:function(){var uri=w3c_slidy.page_address(location.href);var hash="#("+(w3c_slidy.slide_number+1)+")";if(w3c_slidy.slide_number>=0)
uri=uri+hash;if(typeof(history.pushState)!="undefined")
{document.title=w3c_slidy.title+" ("+(w3c_slidy.slide_number+1)+")";history.pushState(0,document.title,hash);w3c_slidy.show_slide_number();w3c_slidy.notify_observers();return;}
if(uri!=location.href)
location.href=uri;if(this.khtml)
hash="("+(w3c_slidy.slide_number+1)+")";if(!this.ie&&location.hash!=hash&&location.hash!="")
location.hash=hash;document.title=w3c_slidy.title+" ("+(w3c_slidy.slide_number+1)+")";w3c_slidy.show_slide_number();w3c_slidy.notify_observers();},notify_observers:function()
{var slide=this.slides[this.slide_number];for(var i=0;i<this.observers.length;++i)
this.observers[i](this.slide_number+1,this.find_heading(slide).innerText,location.href);},add_observer:function(observer)
{for(var i=0;i<this.observers.length;++i)
{if(observer==this.observers[i])
return;}
this.observers.push(observer);},remove_observer:function(o)
{for(var i=0;i<this.observers.length;++i)
{if(observer==this.observers[i])
{this.observers.splice(i,1);break;}}},page_address:function(uri){var i=uri.indexOf("#");if(i<0)
i=uri.indexOf("%23");if(i<0)
return uri;return uri.substr(0,i);},on_frame_loaded:function(hash){location.hash=hash;var uri=w3c_slidy.page_address(location.href);location.href=uri+hash;},push_hash:function(hash){},find_slide_number:function(uri){var i=uri.indexOf("#");if(i<0)
return 0;var anchor=unescape(uri.substr(i+1));var target=document.getElementById(anchor);if(!target)
{var re=/\((\d)+\)/;if(anchor.match(re))
{var num=parseInt(anchor.substring(1,anchor.length-1));if(num>this.slides.length)
num=1;if(--num<0)
num=0;return num;}
re=/\[(\d)+\]/;if(anchor.match(re))
{var num=parseInt(anchor.substring(1,anchor.length-1));if(num>this.slides.length)
num=1;if(--num<0)
num=0;return num;}
return 0;}
while(true)
{if(target.nodeName.toLowerCase()=="div"&&this.has_class(target,"slide"))
{break;}
target=target.parentNode;if(!target)
{return 0;}};for(i=0;i<slides.length;++i)
{if(slides[i]==target)
return i;}
return 0;},previous_slide:function(incremental){if(!w3c_slidy.view_all)
{var slide;if((incremental||w3c_slidy.slide_number==0)&&w3c_slidy.last_shown!=null)
{w3c_slidy.last_shown=w3c_slidy.hide_previous_item(w3c_slidy.last_shown);w3c_slidy.set_eos_status(false);}
else if(w3c_slidy.slide_number>0)
{slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.slide_number=w3c_slidy.slide_number-1;slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.set_visibility_all_incremental("visible");w3c_slidy.last_shown=w3c_slidy.previous_incremental_item(null);w3c_slidy.set_eos_status(true);w3c_slidy.show_slide(slide);}
w3c_slidy.set_location();if(!w3c_slidy.ns_pos)
w3c_slidy.refresh_toolbar(200);}},next_slide:function(incremental){if(!w3c_slidy.view_all)
{var slide,last=w3c_slidy.last_shown;if(incremental||w3c_slidy.slide_number==w3c_slidy.slides.length-1)
w3c_slidy.last_shown=w3c_slidy.reveal_next_item(w3c_slidy.last_shown);if((!incremental||w3c_slidy.last_shown==null)&&w3c_slidy.slide_number<w3c_slidy.slides.length-1)
{slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.slide_number=w3c_slidy.slide_number+1;slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.last_shown=null;w3c_slidy.set_visibility_all_incremental("hidden");w3c_slidy.show_slide(slide);}
else if(!w3c_slidy.last_shown)
{if(last&&incremental)
w3c_slidy.last_shown=last;}
w3c_slidy.set_location();w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));if(!w3c_slidy.ns_pos)
w3c_slidy.refresh_toolbar(200);}},first_slide:function(){if(!w3c_slidy.view_all)
{var slide;if(w3c_slidy.slide_number!=0)
{slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.slide_number=0;slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.last_shown=null;w3c_slidy.set_visibility_all_incremental("hidden");w3c_slidy.show_slide(slide);}
w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));w3c_slidy.set_location();}},last_slide:function(){if(!w3c_slidy.view_all)
{var slide;w3c_slidy.last_shown=null;if(w3c_slidy.last_shown==null&&w3c_slidy.slide_number<w3c_slidy.slides.length-1)
{slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.slide_number=w3c_slidy.slides.length-1;slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.set_visibility_all_incremental("visible");w3c_slidy.last_shown=w3c_slidy.previous_incremental_item(null);w3c_slidy.show_slide(slide);}
else
{w3c_slidy.set_visibility_all_incremental("visible");w3c_slidy.last_shown=w3c_slidy.previous_incremental_item(null);}
w3c_slidy.set_eos_status(true);w3c_slidy.set_location();}},set_eos_status:function(state){if(this.eos)
this.eos.style.color=(state?"rgb(240,240,240)":"red");},goto_slide:function(num){var slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.slide_number=num;slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.last_shown=null;w3c_slidy.set_visibility_all_incremental("hidden");w3c_slidy.set_eos_status(!w3c_slidy.next_incremental_item(w3c_slidy.last_shown));document.title=w3c_slidy.title+" ("+(w3c_slidy.slide_number+1)+")";w3c_slidy.show_slide(slide);w3c_slidy.show_slide_number();},show_slide:function(slide){this.sync_background(slide);this.remove_class(slide,"hidden");setTimeout("window.scrollTo(0,0);",1);},hide_slide:function(slide){this.add_class(slide,"hidden");},set_focus:function(element)
{if(element)
element.focus();else
{w3c_slidy.help_anchor.focus();setTimeout(function(){w3c_slidy.help_anchor.blur();},1);}},sync_background:function(slide){var background;var bgColor;if(slide.currentStyle)
bgColor=slide.currentStyle["backgroundColor"];else if(document.defaultView)
{var styles=document.defaultView.getComputedStyle(slide,null);if(styles)
bgColor=styles.getPropertyValue("background-color");else
{bgColor="transparent";}}
else
bgColor=="transparent";if(bgColor=="transparent"||bgColor.indexOf("rgba")>=0||bgColor.indexOf("opacity")>=0)
{var slideClass=this.get_class_list(slide);for(var i=0;i<this.backgrounds.length;i++)
{background=this.backgrounds[i];var bgClass=this.get_class_list(background);if(this.matching_background(slideClass,bgClass))
this.remove_class(background,"hidden");else
this.add_class(background,"hidden");}}
else
this.hide_backgrounds();},hide_backgrounds:function(){for(var i=0;i<this.backgrounds.length;i++)
{background=this.backgrounds[i];this.add_class(background,"hidden");}},matching_background:function(slideClass,bgClass){var i,count,pattern,result;pattern=/\w+/g;result=bgClass.match(pattern);for(i=count=0;i<result.length;i++)
{if(result[i]=="hidden")
continue;if(result[i]=="background")
continue;++count;}
if(count==0)
return true;result=slideClass.match(pattern);for(i=count=0;i<result.length;i++)
{if(result[i]=="hidden")
continue;if(this.has_token(bgClass,result[i]))
return true;}
return false;},resized:function(){var width=0;if(typeof(window.innerWidth)=='number')
width=window.innerWidth;else if(document.documentElement&&document.documentElement.clientWidth)
width=document.documentElement.clientWidth;else if(document.body&&document.body.clientWidth)
width=document.body.clientWidth;var height=0;if(typeof(window.innerHeight)=='number')
height=window.innerHeight;else if(document.documentElement&&document.documentElement.clientHeight)
height=document.documentElement.clientHeight;else if(document.body&&document.body.clientHeight)
height=document.body.clientHeight;if(height&&(width/height>1.05*1024/768))
{width=height*1024.0/768;}
if(width!=w3c_slidy.last_width||height!=w3c_slidy.last_height)
{if(width>=1100)
w3c_slidy.size_index=5;else if(width>=1000)
w3c_slidy.size_index=4;else if(width>=800)
w3c_slidy.size_index=3;else if(width>=600)
w3c_slidy.size_index=2;else if(width)
w3c_slidy.size_index=0;if(0<=w3c_slidy.size_index+w3c_slidy.size_adjustment&&w3c_slidy.size_index+w3c_slidy.size_adjustment<w3c_slidy.sizes.length)
w3c_slidy.size_index=w3c_slidy.size_index+w3c_slidy.size_adjustment;w3c_slidy.adjust_object_dimensions(width,height);if(document.body.style.fontSize!=w3c_slidy.sizes[w3c_slidy.size_index])
{document.body.style.fontSize=w3c_slidy.sizes[w3c_slidy.size_index];}
w3c_slidy.last_width=width;w3c_slidy.last_height=height;if(w3c_slidy.ns_pos)
{var slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.show_slide(slide);}
w3c_slidy.refresh_toolbar(200);}},scrolled:function(){if(w3c_slidy.toolbar&&!w3c_slidy.ns_pos&&!w3c_slidy.ie7)
{w3c_slidy.hack_offset=w3c_slidy.scroll_x_offset();w3c_slidy.toolbar.style.display="none";if(w3c_slidy.scrollhack==0&&!w3c_slidy.view_all)
{setTimeout(function(){w3c_slidy.show_toolbar();},1000);w3c_slidy.scrollhack=1;}}},hide_toolbar:function(){w3c_slidy.add_class(w3c_slidy.toolbar,"hidden");window.focus();},refresh_toolbar:function(interval){if(!w3c_slidy.ns_pos&&!w3c_slidy.ie7)
{w3c_slidy.hide_toolbar();setTimeout(function(){w3c_slidy.show_toolbar();},interval);}},show_toolbar:function(){if(w3c_slidy.want_toolbar)
{w3c_slidy.toolbar.style.display="block";if(!w3c_slidy.ns_pos)
{var xoffset=w3c_slidy.scroll_x_offset();w3c_slidy.toolbar.style.left=xoffset;w3c_slidy.toolbar.style.right=xoffset;w3c_slidy.toolbar.style.bottom=0;}
w3c_slidy.remove_class(w3c_slidy.toolbar,"hidden");}
w3c_slidy.scrollhack=0;try
{if(!w3c_slidy.opera)
w3c_slidy.set_focus();}
catch(e)
{}},toggle_toolbar:function(){if(!w3c_slidy.view_all)
{if(w3c_slidy.has_class(w3c_slidy.toolbar,"hidden"))
{w3c_slidy.remove_class(w3c_slidy.toolbar,"hidden")
w3c_slidy.want_toolbar=1;}
else
{w3c_slidy.add_class(w3c_slidy.toolbar,"hidden")
w3c_slidy.want_toolbar=0;}}},scroll_x_offset:function(){if(window.pageXOffset)
return self.pageXOffset;if(document.documentElement&&document.documentElement.scrollLeft)
return document.documentElement.scrollLeft;if(document.body)
return document.body.scrollLeft;return 0;},scroll_y_offset:function(){if(window.pageYOffset)
return self.pageYOffset;if(document.documentElement&&document.documentElement.scrollTop)
return document.documentElement.scrollTop;if(document.body)
return document.body.scrollTop;return 0;},optimize_font_size:function(){var slide=w3c_slidy.slides[w3c_slidy.slide_number];var dh=slide.scrollHeight;var wh=getWindowHeight();var u=100*dh/wh;alert("window utilization = "+u+"% (doc "
+dh+" win "+wh+")");},get_doc_height:function(doc){if(!doc)
doc=document;if(doc&&doc.body&&doc.body.offsetHeight)
return doc.body.offsetHeight;if(doc&&doc.body&&doc.body.scrollHeight)
return doc.body.scrollHeight;alert("couldn't determine document height");},get_window_height:function(){if(typeof(window.innerHeight)=='number')
return window.innerHeight;if(document.documentElement&&document.documentElement.clientHeight)
return document.documentElement.clientHeight;if(document.body&&document.body.clientHeight)
return document.body.clientHeight;},document_height:function(){var sh,oh;sh=document.body.scrollHeight;oh=document.body.offsetHeight;if(sh&&oh)
{return(sh>oh?sh:oh);}
return 0;},smaller:function(){if(w3c_slidy.size_index>0)
{--w3c_slidy.size_index;}
w3c_slidy.toolbar.style.display="none";document.body.style.fontSize=w3c_slidy.sizes[w3c_slidy.size_index];var slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.show_slide(slide);setTimeout(function(){w3c_slidy.show_toolbar();},50);},bigger:function(){if(w3c_slidy.size_index<w3c_slidy.sizes.length-1)
{++w3c_slidy.size_index;}
w3c_slidy.toolbar.style.display="none";document.body.style.fontSize=w3c_slidy.sizes[w3c_slidy.size_index];var slide=w3c_slidy.slides[w3c_slidy.slide_number];w3c_slidy.hide_slide(slide);w3c_slidy.show_slide(slide);setTimeout(function(){w3c_slidy.show_toolbar();},50);},adjust_object_dimensions:function(width,height){for(var i=0;i<w3c_slidy.objects.length;i++)
{var obj=this.objects[i];var mimeType=obj.getAttribute("type");if(mimeType=="image/svg+xml"||mimeType=="application/x-shockwave-flash")
{if(!obj.initialWidth)
obj.initialWidth=obj.getAttribute("width");if(!obj.initialHeight)
obj.initialHeight=obj.getAttribute("height");if(obj.initialWidth&&obj.initialWidth.charAt(obj.initialWidth.length-1)=="%")
{var w=parseInt(obj.initialWidth.slice(0,obj.initialWidth.length-1));var newW=width*(w/100.0);obj.setAttribute("width",newW);}
if(obj.initialHeight&&obj.initialHeight.charAt(obj.initialHeight.length-1)=="%")
{var h=parseInt(obj.initialHeight.slice(0,obj.initialHeight.length-1));var newH=height*(h/100.0);obj.setAttribute("height",newH);}}}},key_press:function(event){if(!event)
event=window.event;if(!w3c_slidy.key_wanted)
return w3c_slidy.cancel(event);return true;},key_down:function(event){var key,target,tag;w3c_slidy.key_wanted=true;if(!event)
event=window.event;if(window.event)
{key=window.event.keyCode;target=window.event.srcElement;}
else if(event.which)
{key=event.which;target=event.target;}
else
return true;if(!key)
return true;if(!w3c_slidy.slidy_chrome(target)&&w3c_slidy.special_element(target))
return true;if(event.ctrlKey||event.altKey||event.metaKey)
return true;if(w3c_slidy.is_shown_toc()&&key!=9&&key!=16&&key!=38&&key!=40)
{w3c_slidy.hide_table_of_contents(true);if(key==27||key==84||key==67)
return w3c_slidy.cancel(event);}
if(key==34)
{if(w3c_slidy.view_all)
return true;w3c_slidy.next_slide(false);return w3c_slidy.cancel(event);}
else if(key==33)
{if(w3c_slidy.view_all)
return true;w3c_slidy.previous_slide(false);return w3c_slidy.cancel(event);}
else if(key==32)
{w3c_slidy.next_slide(true);return w3c_slidy.cancel(event);}
else if(key==37)
{w3c_slidy.previous_slide(!event.shiftKey);return w3c_slidy.cancel(event);}
else if(key==36)
{w3c_slidy.first_slide();return w3c_slidy.cancel(event);}
else if(key==35)
{w3c_slidy.last_slide();return w3c_slidy.cancel(event);}
else if(key==39)
{w3c_slidy.next_slide(!event.shiftKey);return w3c_slidy.cancel(event);}
else if(key==13)
{if(w3c_slidy.outline)
{if(w3c_slidy.outline.visible)
w3c_slidy.fold(w3c_slidy.outline);else
w3c_slidy.unfold(w3c_slidy.outline);return w3c_slidy.cancel(event);}}
else if(key==188)
{w3c_slidy.smaller();return w3c_slidy.cancel(event);}
else if(key==190)
{w3c_slidy.bigger();return w3c_slidy.cancel(event);}
else if(key==189||key==109)
{w3c_slidy.smaller();return w3c_slidy.cancel(event);}
else if(key==187||key==191||key==107)
{w3c_slidy.bigger();return w3c_slidy.cancel(event);}
else if(key==83)
{w3c_slidy.smaller();return w3c_slidy.cancel(event);}
else if(key==66)
{w3c_slidy.bigger();return w3c_slidy.cancel(event);}
else if(key==90)
{w3c_slidy.last_slide();return w3c_slidy.cancel(event);}
else if(key==70)
{w3c_slidy.toggle_toolbar();return w3c_slidy.cancel(event);}
else if(key==65)
{w3c_slidy.toggle_view();return w3c_slidy.cancel(event);}
else if(key==75)
{w3c_slidy.mouse_click_enabled=!w3c_slidy.mouse_click_enabled;var alert_msg=(w3c_slidy.mouse_click_enabled?"enabled":"disabled")+" mouse click advance";alert(w3c_slidy.localize(alert_msg));return w3c_slidy.cancel(event);}
else if(key==84||key==67)
{if(w3c_slidy.toc)
w3c_slidy.toggle_table_of_contents();return w3c_slidy.cancel(event);}
else if(key==72)
{window.location=w3c_slidy.help_page;return w3c_slidy.cancel(event);}
return true;},create_element:function(name){if(this.xhtml&&(typeof document.createElementNS!='undefined'))
return document.createElementNS("http://www.w3.org/1999/xhtml",name)
return document.createElement(name);},get_element_style:function(elem,IEStyleProp,CSSStyleProp){if(elem.currentStyle)
{return elem.currentStyle[IEStyleProp];}
else if(window.getComputedStyle)
{var compStyle=window.getComputedStyle(elem,"");return compStyle.getPropertyValue(CSSStyleProp);}
return"";},has_token:function(str,token){if(str)
{var pattern=/\w+/g;var result=str.match(pattern);for(var i=0;i<result.length;i++)
{if(result[i]==token)
return true;}}
return false;},get_class_list:function(element){if(typeof element.className!='undefined')
return element.className;return element.getAttribute("class");},has_class:function(element,name){if(element.nodeType!=1)
return false;var regexp=new RegExp("(^| )"+name+"\W*");if(typeof element.className!='undefined')
return regexp.test(element.className);return regexp.test(element.getAttribute("class"));},remove_class:function(element,name){var regexp=new RegExp("(^| )"+name+"\W*");var clsval="";if(typeof element.className!='undefined')
{clsval=element.className;if(clsval)
{clsval=clsval.replace(regexp,"");element.className=clsval;}}
else
{clsval=element.getAttribute("class");if(clsval)
{clsval=clsval.replace(regexp,"");element.setAttribute("class",clsval);}}},add_class:function(element,name){if(!this.has_class(element,name))
{if(typeof element.className!='undefined')
element.className+=" "+name;else
{var clsval=element.getAttribute("class");clsval=clsval?clsval+" "+name:name;element.setAttribute("class",clsval);}}},incremental_elements:null,okay_for_incremental:function(name){if(!this.incremental_elements)
{var inclist=new Array();inclist["p"]=true;inclist["pre"]=true;inclist["li"]=true;inclist["blockquote"]=true;inclist["dt"]=true;inclist["dd"]=true;inclist["h2"]=true;inclist["h3"]=true;inclist["h4"]=true;inclist["h5"]=true;inclist["h6"]=true;inclist["span"]=true;inclist["address"]=true;inclist["table"]=true;inclist["tr"]=true;inclist["th"]=true;inclist["td"]=true;inclist["img"]=true;inclist["object"]=true;this.incremental_elements=inclist;}
return this.incremental_elements[name.toLowerCase()];},next_incremental_item:function(node){var br=this.is_xhtml?"br":"BR";var slide=w3c_slidy.slides[w3c_slidy.slide_number];for(;;)
{node=w3c_slidy.next_node(slide,node);if(node==null||node.parentNode==null)
break;if(node.nodeType==1)
{if(node.nodeName==br)
continue;if(w3c_slidy.has_class(node,"incremental")&&w3c_slidy.okay_for_incremental(node.nodeName))
return node;if(w3c_slidy.has_class(node.parentNode,"incremental")&&!w3c_slidy.has_class(node,"non-incremental"))
return node;}}
return node;},previous_incremental_item:function(node){var br=this.is_xhtml?"br":"BR";var slide=w3c_slidy.slides[w3c_slidy.slide_number];for(;;)
{node=w3c_slidy.previous_node(slide,node);if(node==null||node.parentNode==null)
break;if(node.nodeType==1)
{if(node.nodeName==br)
continue;if(w3c_slidy.has_class(node,"incremental")&&w3c_slidy.okay_for_incremental(node.nodeName))
return node;if(w3c_slidy.has_class(node.parentNode,"incremental")&&!w3c_slidy.has_class(node,"non-incremental"))
return node;}}
return node;},set_visibility_all_incremental:function(value){var node=this.next_incremental_item(null);if(value=="hidden")
{while(node)
{w3c_slidy.add_class(node,"invisible");node=w3c_slidy.next_incremental_item(node);}}
else
{while(node)
{w3c_slidy.remove_class(node,"invisible");node=w3c_slidy.next_incremental_item(node);}}},reveal_next_item:function(node){node=w3c_slidy.next_incremental_item(node);if(node&&node.nodeType==1)
w3c_slidy.remove_class(node,"invisible");return node;},hide_previous_item:function(node){if(node&&node.nodeType==1)
w3c_slidy.add_class(node,"invisible");return this.previous_incremental_item(node);},next_node:function(root,node){if(node==null)
return root.firstChild;if(node.firstChild)
return node.firstChild;if(node.nextSibling)
return node.nextSibling;for(;;)
{node=node.parentNode;if(!node||node==root)
break;if(node&&node.nextSibling)
return node.nextSibling;}
return null;},previous_node:function(root,node){if(node==null)
{node=root.lastChild;if(node)
{while(node.lastChild)
node=node.lastChild;}
return node;}
if(node.previousSibling)
{node=node.previousSibling;while(node.lastChild)
node=node.lastChild;return node;}
if(node.parentNode!=root)
return node.parentNode;return null;},previous_sibling_element:function(el){el=el.previousSibling;while(el&&el.nodeType!=1)
el=el.previousSibling;return el;},next_sibling_element:function(el){el=el.nextSibling;while(el&&el.nodeType!=1)
el=el.nextSibling;return el;},first_child_element:function(el){var node;for(node=el.firstChild;node;node=node.nextSibling)
{if(node.nodeType==1)
break;}
return node;},first_tag:function(element,tag){var node;if(!this.is_xhtml)
tag=tag.toUpperCase();for(node=element.firstChild;node;node=node.nextSibling)
{if(node.nodeType==1&&node.nodeName==tag)
break;}
return node;},hide_selection:function(){if(window.getSelection)
{var selection=window.getSelection();if(selection.rangeCount>0)
{var range=selection.getRangeAt(0);range.collapse(false);}}
else
{var textRange=document.selection.createRange();textRange.collapse(false);}},get_selected_text:function(){try
{if(window.getSelection)
return window.getSelection().toString();if(document.getSelection)
return document.getSelection().toString();if(document.selection)
return document.selection.createRange().text;}
catch(e)
{}
return"";},mouse_button_up:function(e){w3c_slidy.selected_text_len=w3c_slidy.get_selected_text().length;},mouse_button_down:function(e){w3c_slidy.selected_text_len=w3c_slidy.get_selected_text().length;w3c_slidy.mouse_x=e.clientX;w3c_slidy.mouse_y=e.clientY;},mouse_button_click:function(e){if(!e)
var e=window.event;if(Math.abs(e.clientX-w3c_slidy.mouse_x)+
Math.abs(e.clientY-w3c_slidy.mouse_y)>10)
return true;if(w3c_slidy.selected_text_len>0)
return true;var rightclick=false;var leftclick=false;var middleclick=false;var target;if(!e)
var e=window.event;if(e.target)
target=e.target;else if(e.srcElement)
target=e.srcElement;if(target.nodeType==3)
target=target.parentNode;if(e.which)
{leftclick=(e.which==1);middleclick=(e.which==2);rightclick=(e.which==3);}
else if(e.button)
{if(e.button==4)
middleclick=true;rightclick=(e.button==2);}
else
leftclick=true;if(w3c_slidy.selected_text_len>0)
{w3c_slidy.stop_propagation(e);e.cancel=true;e.returnValue=false;return false;}
w3c_slidy.hide_table_of_contents(false);var tag=target.nodeName.toLowerCase();if(w3c_slidy.mouse_click_enabled&&leftclick&&!w3c_slidy.special_element(target)&&!target.onclick)
{w3c_slidy.next_slide(true);w3c_slidy.stop_propagation(e);e.cancel=true;e.returnValue=false;return false;}
return true;},special_element:function(element){if(this.has_class(element,"non-interactive"))
return false;var tag=element.nodeName.toLowerCase();return element.onkeydown||element.onclick||tag=="a"||tag=="embed"||tag=="object"||tag=="video"||tag=="audio"||tag=="svg"||tag=="canvas"||tag=="input"||tag=="textarea"||tag=="select"||tag=="option";},slidy_chrome:function(el){while(el)
{if(el==w3c_slidy.toc||el==w3c_slidy.toolbar||w3c_slidy.has_class(el,"outline"))
return true;el=el.parentNode;}
return false;},get_key:function(e)
{var key;if(typeof window.event!="undefined")
key=window.event.keyCode;else if(e.which)
key=e.which;return key;},get_target:function(e){var target;if(!e)
e=window.event;if(e.target)
target=e.target;else if(e.srcElement)
target=e.srcElement;if(target.nodeType!=1)
target=target.parentNode;return target;},is_block:function(elem){var tag=elem.nodeName.toLowerCase();return tag=="ol"||tag=="ul"||tag=="p"||tag=="dl"||tag=="li"||tag=="table"||tag=="pre"||tag=="h1"||tag=="h2"||tag=="h3"||tag=="h4"||tag=="h5"||tag=="h6"||tag=="blockquote"||tag=="address";},add_listener:function(element,event,handler){if(window.addEventListener)
element.addEventListener(event,handler,false);else
element.attachEvent("on"+event,handler);},stop_propagation:function(event){event=event?event:window.event;event.cancelBubble=true;if(event.stopPropagation)
event.stopPropagation();return true;},cancel:function(event){if(event)
{event.cancel=true;event.returnValue=false;if(event.preventDefault)
event.preventDefault();}
w3c_slidy.key_wanted=false;return false;},strings_es:{"slide":"pág.","help?":"Ayuda","contents?":"Índice","table of contents":"tabla de contenidos","Table of Contents":"Tabla de Contenidos","restart presentation":"Reiniciar presentación","restart?":"Inicio"},help_es:"Utilice el ratón, barra espaciadora, teclas Izda/Dcha, "+"o Re pág y Av pág. Use S y B para cambiar el tamaño de fuente.",strings_ca:{"slide":"pàg..","help?":"Ajuda","contents?":"Índex","table of contents":"taula de continguts","Table of Contents":"Taula de Continguts","restart presentation":"Reiniciar presentació","restart?":"Inici"},help_ca:"Utilitzi el ratolí, barra espaiadora, tecles Esq./Dta. "+"o Re pàg y Av pàg. Usi S i B per canviar grandària de font.",strings_cs:{"slide":"snímek","help?":"nápověda","contents?":"obsah","table of contents":"obsah prezentace","Table of Contents":"Obsah prezentace","restart presentation":"znovu spustit prezentaci","restart?":"restart"},help_cs:"Prezentaci můžete procházet pomocí kliknutí myši, mezerníku, "+"šipek vlevo a vpravo nebo kláves PageUp a PageDown. Písmo se "+"dá zvětšit a zmenšit pomocí kláves B a S.",strings_nl:{"slide":"pagina","help?":"Help?","contents?":"Inhoud?","table of contents":"inhoudsopgave","Table of Contents":"Inhoudsopgave","restart presentation":"herstart presentatie","restart?":"Herstart?"},help_nl:"Navigeer d.m.v. het muis, spatiebar, Links/Rechts toetsen, "+"of PgUp en PgDn. Gebruik S en B om de karaktergrootte te veranderen.",strings_de:{"slide":"Seite","help?":"Hilfe","contents?":"Übersicht","table of contents":"Inhaltsverzeichnis","Table of Contents":"Inhaltsverzeichnis","restart presentation":"Präsentation neu starten","restart?":"Neustart"},help_de:"Benutzen Sie die Maus, Leerschlag, die Cursortasten links/rechts oder "+"Page up/Page Down zum Wechseln der Seiten und S und B für die Schriftgrösse.",strings_pl:{"slide":"slajd","help?":"pomoc?","contents?":"spis treści?","table of contents":"spis treści","Table of Contents":"Spis Treści","restart presentation":"Restartuj prezentację","restart?":"restart?"},help_pl:"Zmieniaj slajdy klikając myszą, naciskając spację, strzałki lewo/prawo"+"lub PgUp / PgDn. Użyj klawiszy S i B, aby zmienić rozmiar czczionki.",strings_fr:{"slide":"page","help?":"Aide","contents?":"Index","table of contents":"table des matières","Table of Contents":"Table des matières","restart presentation":"Recommencer l'exposé","restart?":"Début"},help_fr:"Naviguez avec la souris, la barre d'espace, les flèches "+"gauche/droite ou les touches Pg Up, Pg Dn. Utilisez "+"les touches S et B pour modifier la taille de la police.",strings_hu:{"slide":"oldal","help?":"segítség","contents?":"tartalom","table of contents":"tartalomjegyzék","Table of Contents":"Tartalomjegyzék","restart presentation":"bemutató újraindítása","restart?":"újraindítás"},help_hu:"Az oldalak közti lépkedéshez kattintson az egérrel, vagy "+"használja a szóköz, a bal, vagy a jobb nyíl, illetve a Page Down, "+"Page Up billentyűket. Az S és a B billentyűkkel változtathatja "+"a szöveg méretét.",strings_it:{"slide":"pag.","help?":"Aiuto","contents?":"Indice","table of contents":"indice","Table of Contents":"Indice","restart presentation":"Ricominciare la presentazione","restart?":"Inizio"},help_it:"Navigare con mouse, barra spazio, frecce sinistra/destra o "+"PgUp e PgDn. Usare S e B per cambiare la dimensione dei caratteri.",strings_el:{"slide":"σελίδα","help?":"βοήθεια;","contents?":"περιεχόμενα;","table of contents":"πίνακας περιεχομένων","Table of Contents":"Πίνακας Περιεχομένων","restart presentation":"επανεκκίνηση παρουσίασης","restart?":"επανεκκίνηση;"},help_el:"Πλοηγηθείτε με το κλίκ του ποντικιού, το space, τα βέλη αριστερά/δεξιά, "+"ή Page Up και Page Down. Χρησιμοποιήστε τα πλήκτρα S και B για να αλλάξετε "+"το μέγεθος της γραμματοσειράς.",strings_ja:{"slide":"スライド","help?":"ヘルプ","contents?":"目次","table of contents":"目次を表示","Table of Contents":"目次","restart presentation":"最初から再生","restart?":"最初から"},help_ja:"マウス左クリック ・ スペース ・ 左右キー "+"または Page Up ・ Page Downで操作， S ・ Bでフォントサイズ変更",strings_zh:{"slide":"幻灯片","help?":"帮助?","contents?":"内容?","table of contents":"目录","Table of Contents":"目录","restart presentation":"重新启动展示","restart?":"重新启动?"},help_zh:"用鼠标点击, 空格条, 左右箭头, Pg Up 和 Pg Dn 导航. "+"用 S, B 改变字体大小.",strings_ru:{"slide":"слайд","help?":"помощь?","contents?":"содержание?","table of contents":"оглавление","Table of Contents":"Оглавление","restart presentation":"перезапустить презентацию","restart?":"перезапуск?"},help_ru:"Перемещайтесь кликая мышкой, используя клавишу пробел, стрелки"+"влево/вправо или Pg Up и Pg Dn. Клавиши S и B меняют размер шрифта.",strings_sv:{"slide":"sida","help?":"hjälp","contents?":"innehåll","table of contents":"innehållsförteckning","Table of Contents":"Innehållsförteckning","restart presentation":"visa presentationen från början","restart?":"börja om"},help_sv:"Bläddra med ett klick med vänstra musknappen, mellanslagstangenten, "+"vänster- och högerpiltangenterna eller tangenterna Pg Up, Pg Dn. "+"Använd tangenterna S och B för att ändra textens storlek.",strings:{},localize:function(src){if(src=="")
return src;var s,lookup=w3c_slidy.strings[w3c_slidy.lang];if(lookup)
{s=lookup[src];if(s)
return s;}
var lg=w3c_slidy.lang.split("-");if(lg.length>1)
{lookup=w3c_slidy.strings[lg[0]];if(lookup)
{s=lookup[src];if(s)
return s;}}
return src;},init_localization:function(){var i18n=w3c_slidy;var help_text=w3c_slidy.help_text;this.strings={"es":this.strings_es,"ca":this.strings_ca,"cs":this.strings_cs,"nl":this.strings_nl,"de":this.strings_de,"pl":this.strings_pl,"fr":this.strings_fr,"hu":this.strings_hu,"it":this.strings_it,"el":this.strings_el,"jp":this.strings_ja,"zh":this.strings_zh,"ru":this.strings_ru,"sv":this.strings_sv},i18n.strings_es[help_text]=i18n.help_es;i18n.strings_ca[help_text]=i18n.help_ca;i18n.strings_cs[help_text]=i18n.help_cs;i18n.strings_nl[help_text]=i18n.help_nl;i18n.strings_de[help_text]=i18n.help_de;i18n.strings_pl[help_text]=i18n.help_pl;i18n.strings_fr[help_text]=i18n.help_fr;i18n.strings_hu[help_text]=i18n.help_hu;i18n.strings_it[help_text]=i18n.help_it;i18n.strings_el[help_text]=i18n.help_el;i18n.strings_ja[help_text]=i18n.help_ja;i18n.strings_zh[help_text]=i18n.help_zh;i18n.strings_ru[help_text]=i18n.help_ru;i18n.strings_sv[help_text]=i18n.help_sv;w3c_slidy.lang=document.body.parentNode.getAttribute("lang");if(!w3c_slidy.lang)
w3c_slidy.lang=document.body.parentNode.getAttribute("xml:lang");if(!w3c_slidy.lang)
w3c_slidy.lang="en";}};w3c_slidy.set_up();setTimeout(w3c_slidy.hide_slides,50);</script>

    
    
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/contrib/auto-render.min.js"></script>
    
    
    
    <!-- font-awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    
    
    <style type="text/css">
      <!-- 
          body.hl{background-color:#272822}code.hl{color:#f8f8f2;background-color:#272822;font-family:courier new,monospace}.hl.num{color:#ae81ff}.hl.esc{color:#66d9ef;font-style:italic}.hl.str{color:#e6db74}.hl.pps{color:#e6db74}.hl.slc{color:#75715e}.hl.com{color:#75715e}.hl.ppc{color:#defa25}.hl.opt{color:#f8f8f2}.hl.ipl{color:#66d9ef;font-style:italic}.hl.lin{color:#75715e}.hl.kwa{color:#f92672;font-weight:700}.hl.kwb{color:#66d9ef}.hl.kwc{color:#95f067}.hl.kwd{color:#25faac}  
          body{color:#444}div.slide h1{color:#333;font-size:260%;font-family:helvetica,sans-serif;border-bottom:5px solid #ddd}div.slide h2{color:#333;font-size:180%;font-family:helvetica,sans-serif}div.slide.title{background:#0071b5;color:#fff}div.slide.title h1,div.slide.title h2,div.slide.title h3{color:#fff;margin-left:0}div.slide.title h1{padding-top:20%;border:0}div.slide.title h2{}div.slide.title h3{font-size:90%}ul,ol{padding-left:2em}ul ul{padding-left:1em}p{padding-left:0}code{font:normal 1rem droid sans mono,monaco,monospace;background-color:#ddd}pre code{border-radius:8px;box-shadow:8px 8px 12px #aaa;padding:10px;display:block}.Cblue{color:#5af}.center{text-align:center;margin:0 auto}@media print{body{font-size:16pt}div.handout{visibility:none}div.slide.title{background:#fff}div.slide.title h1,div.slide.title h2,div.slide.title h3{color:#ba0d20;margin-left:0}pre{font-size:1e2%;font-weight:400;line-height:120%}}  
          div.slide h2{margin-left:0;padding-left:0;color:#7e8bd6;font-size:180%;font-family:helvetica,sans-serif}.mybox{margin:0 5%;box-shadow:8px 8px 12px #aaa;border-radius:8px;background:#ccc}table{border-collapse:collapse}.borderedtable th,.borderedtable td{border:2px solid #000;padding:1px 7px}.borderedtable th{background:#b5d6e9}table.col2,th.col2,td.col2{border:0 solid green;padding:0;font-size:80%}code{padding:2px 4px;font-size:90%;color:#c7254e;background-color:#f9f2f4;border-radius:4px}code.hl{font-family:monospace}.bigger{font-size:1.8;line-height:120%} 
      -->
    </style>
    
    <title>Implémentation des objets</title>
  </head>

  <!-- ====================================================================== -->

  <body>

    <!-- Powerpoint like headers  -->
    <!--
    <div class="background"> 
      <img id="head-icon" alt="Polytech logo"
           src="http://www.polytechnice.fr/jahia/webdav/site/polytech/shared/PUBLIC/charte_graphique/LOGOTYPE_POLYTECH/POLYTECH_RVB.jpg"
           width="100px"/> 
      <object id="head-logo" title="W3C logo" type="image/svg+xml"
              data="http://www.w3.org/Talks/Tools/Slidy2/graphics/w3c-logo-white.svg">
        <img src="http://www.w3.org/Talks/Tools/Slidy2/graphics/w3c-logo-white.gif" 
             alt="W3C logo" id="head-logo-fallback" />
      </object>
    </div>
    -->


    <!-- First slide -->
    <div class="slide title"> 
      <h1>Implémentation des objets</h1>
      
      <h3>SI4 — 2017-2018</h3>
      <br /><br />Erick Gallesio
    </div>



<h1 id="introduction">Introduction</h1>

<p>Pour l&#39;implémentation de la version complète de Toy, il faut:</p>

<ul>
<li>trouver une représentation de chacun des concepts objet en C.</li>
<li>probablement implémenter une partie des fonctionnalités au travers
de structures/fonctions du support d&#39;exécution (runtime)</li>
</ul>

<p>En particulier: il faut implémenter</p>

<ul>
<li>les attributs des objets (partie données)</li>
<li>les méthodes des objets (partie code)</li>
<li>le mot clé <strong>this</strong> (et <strong>super</strong>)</li>
<li>le polymorphisme</li>
<li>la liaison dynamique</li>
<li>les méthodes prédéfinies (<code>printobj</code>, <code>typename</code>)</li>
<li>la notion de méta-classe</li>
<li>l&#39;héritage</li>
<li>...</li>
</ul>

<h1 id="problèmes-de-production-de-code-13">Problèmes de production de code (1/3)</h1>

<p>Les structures de C ne permettent pas le polymorphisme:</p>

<ul>
<li><p>Pour une classe <code>A</code></p>

<pre><code class="hl c++"><span class="hl kwc">class</span> A <span class="hl opt">{...};</span>                    ⇒   <span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> A <span class="hl opt">*</span>A<span class="hl opt">;</span>
                                      <span class="hl kwb">struct</span> A <span class="hl opt">{ ... };</span>
</code></pre></li>
<li><p>Pour <code>B</code> qui hérite de <code>A</code>:</p>

<pre><code class="hl c++"><span class="hl kwc">class</span> B extends A  <span class="hl opt">{...};</span>         ⇒   <span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> B <span class="hl opt">*</span>B<span class="hl opt">;</span>
                                      <span class="hl kwb">struct</span> B <span class="hl opt">{ ... };</span>
</code></pre></li>
<li><p>Le polymorphisme proprement dit:</p>

<pre><code class="hl c++">   A a<span class="hl opt">;</span>                           ⇒   A a<span class="hl opt">;</span>
   B b<span class="hl opt">;</span>                               B b<span class="hl opt">;</span>
   a <span class="hl opt">=</span> b<span class="hl opt">;</span>                             a <span class="hl opt">= (</span>B<span class="hl opt">)</span> b<span class="hl opt">;</span>
</code></pre></li>
</ul>

<h1 id="problèmes-de-production-de-code-23">Problèmes de production de code (2/3)</h1>

<p>C ne propose pas de <strong>méthodes</strong> ni de <strong>surcharge</strong></p>

<pre><code class="hl java"><span class="hl kwa">class</span> A <span class="hl opt">{</span>
    <span class="hl kwa">int</span> x<span class="hl opt">;</span>
    <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwa">int</span> i<span class="hl opt">) {</span> x <span class="hl opt">=</span> i<span class="hl opt">; }</span>
<span class="hl opt">}</span>
<span class="hl kwa">class</span> B <span class="hl kwa">extends</span> A <span class="hl opt">{</span>
    <span class="hl kwa">int</span> x<span class="hl opt">;</span>
    <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwa">int</span> i<span class="hl opt">) {</span> <span class="hl kwa">super</span><span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span> x <span class="hl opt">=</span> <span class="hl num">2</span> <span class="hl opt">*</span>i<span class="hl opt">; }</span>
<span class="hl opt">}</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c"><span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> A <span class="hl opt">*</span>A<span class="hl opt">;</span>        <span class="hl kwb">struct</span> A <span class="hl opt">{</span> <span class="hl kwb">int</span> A_x<span class="hl opt">; };</span>

<span class="hl kwb">void</span> <span class="hl kwd">_A_f</span><span class="hl opt">(</span>A <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwb">int</span> i<span class="hl opt">) {</span>            <span class="hl slc">// Implémentation du f de A</span>
  <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>A_x <span class="hl opt">=</span> i<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> B <span class="hl opt">*</span>B<span class="hl opt">;</span>       <span class="hl kwb">struct</span> B <span class="hl opt">{ ...;</span> <span class="hl kwb">int</span> B_x<span class="hl opt">; };</span>

<span class="hl kwb">void</span> <span class="hl kwd">_B_f</span><span class="hl opt">(</span>B <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwb">int</span> i<span class="hl opt">) {</span>            <span class="hl slc">// Implémentation du f de B</span>
  <span class="hl kwd">_A_f</span><span class="hl opt">((</span>A<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>                  <span class="hl slc">// super.f(1)</span>
  <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>B_x <span class="hl opt">=</span> <span class="hl num">2</span> <span class="hl opt">*</span> i<span class="hl opt">;</span>                  <span class="hl slc">// x = 2 * i</span>
<span class="hl opt">}</span>
</code></pre>

<h1 id="problèmes-de-production-de-code-33">Problèmes de production de code (3/3)</h1>

<p>C ne propose pas de <strong>liaison dynamique</strong>:</p>

<pre><code class="hl java">   A a<span class="hl opt">;</span> B b<span class="hl opt">;</span>                A a<span class="hl opt">;</span> B b<span class="hl opt">;</span>
                     ⟹
   a<span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>                  <span class="hl kwd">_A_f</span><span class="hl opt">(</span>a<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
   b<span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>                  <span class="hl kwd">_B_f</span><span class="hl opt">(</span>b<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>
   <span class="hl kwa">if</span> <span class="hl opt">(</span>ok<span class="hl opt">)</span> a <span class="hl opt">=</span> b<span class="hl opt">;</span>           <span class="hl kwa">if</span> <span class="hl opt">(</span>ok<span class="hl opt">)</span> a <span class="hl opt">= (</span>B<span class="hl opt">)</span> b<span class="hl opt">;</span>
   a<span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">)</span>                   <span class="hl slc">// Qui appeler ici: _A_f ou _B_f ?????</span>
</code></pre>

<ul>
<li><p>En général, on doit traduire l’appel <code>a.f(1)</code> sans savoir qu’il
existe la classe B, donc la production de code suivante ne peut
pas être:</p>

<pre><code class="hl c">si type de a <span class="hl opt">==</span> A       alors A_F
sinon si type de a <span class="hl opt">==</span> B alors B_F
sinon si <span class="hl opt">...</span>
 ```
</code></pre></li>
<li><p>De plus, on veut produire du code <strong>statique</strong> (<em>i.e.</em> sans support du
<em>runtime</em>)</p></li>
<li><p>⟹  l’objet repéré par <code>a</code> <strong>doit connaître son type</strong> pour savoir quelle
méthode appeler.</p></li>
</ul>

<p>On doit donc être capable d&#39;avoir des objets qui représentent des classes (objets de type <strong>métaclasse</strong>).</p>

<h1 id="notion-de-métaclasse-13">Notion de métaclasse (1/3)</h1>

<p>Une implémentation possible pour la <strong>liaison dynamique</strong>:</p>

<ul>
<li>utiliser la forme des objets que l&#39;on a vu pour représenter les
objets de l&#39;arbre syntaxique.</li>
<li>implémenter les méthodes de l&#39;objet comme des pointeurs sur fonctions.</li>
</ul>

<p>On aurait quelque chose comme:</p>

<pre><code class="hl c">    <span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> A <span class="hl opt">*</span>A<span class="hl opt">;</span>
    <span class="hl kwb">struct</span> A <span class="hl opt">{</span>
        <span class="hl kwb">int</span> A_x<span class="hl opt">;</span>
        <span class="hl kwb">void</span> <span class="hl opt">(*</span>A_f<span class="hl opt">)((</span>A <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwb">int</span> i<span class="hl opt">);</span> <span class="hl slc">// initialisé à _A_f sur new</span>
    <span class="hl opt">};</span>

    <span class="hl kwb">void</span> <span class="hl kwd">_A_f</span><span class="hl opt">(</span>A <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwb">int</span> i<span class="hl opt">) {</span>
        <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>A_x <span class="hl opt">=</span> i<span class="hl opt">;</span>
    <span class="hl opt">}</span>
</code></pre>

<p>Peu efficace si on a:</p>

<ul>
<li>beaucoup de méthodes virtuelles</li>
<li>beaucoup d&#39;objets</li>
</ul>

<p><strong>Idée</strong>: Avoir un pointeur dans chaque objet qui pointe vers un descripteur de la classe.</p>

<h1 id="notion-de-métaclasse-23">Notion de métaclasse (2/3)</h1>

<dl>
<dt><strong>Définition</strong>:</dt>
<dd>A chaque objet d&#39;une classe donnée est associé un objet permettant
de décrire cette classe (cet objet est une instance de la classe
<code>metaclass</code>).</dd>
</dl>

<p>Selon le langage, cette description est plus ou moins riche, mais
elle contient toujours les adresses des méthodes de la classe.</p>

<p>Le compilateur <em>Toy</em> représente les métaclasses par la structure
suivante:</p>

<pre><code class="hl c"><span class="hl slc">// --- Structure used for toy metaclasses</span>
<span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> _toy_metaclass <span class="hl opt">{</span>
  <span class="hl kwb">char</span> <span class="hl opt">*</span>classname<span class="hl opt">;</span>                      <span class="hl slc">// name of the class</span>
  <span class="hl kwb">struct</span> _toy_metaclass <span class="hl opt">*</span>extends_meta<span class="hl opt">;</span>  <span class="hl slc">// meta of inherited class</span>
  <span class="hl kwb">void</span><span class="hl opt">*</span> methods <span class="hl opt">[];</span>                     <span class="hl slc">// array of methods addr</span>
<span class="hl opt">}</span> _toy_metaclass<span class="hl opt">;</span>
</code></pre>

<p>De plus, le compilateur définit (durant son <strong>bootstrap</strong>) une métaclasse
pour la classe <em>Object</em>:</p>

<pre><code class="hl c"><span class="hl kwc">extern</span>
_toy_metaclass _toy_meta_Object<span class="hl opt">;</span> <span class="hl slc">// The metaclass of Object</span>

</code></pre>

<h1 id="notion-de-métaclasse-33">Notion de métaclasse (3/3)</h1>

<p>Par conséquent, pour la méthode <code>A::f</code></p>

<pre><code class="hl java"><span class="hl kwa">class</span> A <span class="hl opt">{</span>
    <span class="hl kwa">int</span> x<span class="hl opt">;</span>
    <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwa">int</span> i<span class="hl opt">) {</span> x <span class="hl opt">=</span> i<span class="hl opt">; }</span>
<span class="hl opt">}</span>
</code></pre>

<p>⟹ on produit ce code</p>

<pre><code class="hl c"><span class="hl slc">// Code de la Méthode f</span>
<span class="hl kwb">void</span> <span class="hl kwd">_A_f</span><span class="hl opt">(</span>A <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwb">int</span> i<span class="hl opt">) {</span>
    <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>A_x <span class="hl opt">=</span> i<span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl slc">// Métaclasse de A</span>
_toy_metaclass _toy_meta_A <span class="hl opt">= {</span>
     <span class="hl opt">.</span>classname    <span class="hl opt">=</span> <span class="hl str">&quot;A&quot;</span><span class="hl opt">,</span>
     <span class="hl opt">.</span>extends_meta <span class="hl opt">= &amp;</span>_toy_meta_Object<span class="hl opt">,</span>       <span class="hl slc">// ⇒ Classe A hérite de Object</span>
     <span class="hl opt">.</span>methods      <span class="hl opt">= {</span>
        _Object_printobj<span class="hl opt">,</span>                    <span class="hl slc">// Méthode prédéfinie</span>
        _Object_typename<span class="hl opt">,</span>                    <span class="hl slc">// Méthode prédéfinie</span>
        _A_f                                 <span class="hl slc">// Méthode A::f</span>
     <span class="hl opt">}</span>
<span class="hl opt">};</span>
</code></pre>

<h1 id="implémentation-dun-objet-14">Implémentation d&#39;un objet (1/4)</h1>

<p>Soit la classe:</p>

<pre><code class="hl java"><span class="hl kwa">class</span> A <span class="hl opt">{</span>
    <span class="hl kwa">int</span> x<span class="hl opt">;</span>
    <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwa">int</span> i<span class="hl opt">) {</span> x <span class="hl opt">=</span> i<span class="hl opt">; }</span>
<span class="hl opt">};</span>
</code></pre>

<p>Le type permettant de représenter les objets de la classe est défini comme:</p>

<pre><code class="hl c"><span class="hl kwc">typedef</span> <span class="hl kwb">struct</span> A <span class="hl opt">*</span>A<span class="hl opt">;</span> <span class="hl slc">// class A implementation typedef</span>
<span class="hl kwb">struct</span> A <span class="hl opt">{</span>
  _toy_metaclass <span class="hl opt">*</span>_instance_of<span class="hl opt">;</span>
  <span class="hl kwb">int</span> A_x<span class="hl opt">;</span>
<span class="hl opt">};</span>
</code></pre>

<p>On note que:</p>

<ul>
<li>seuls les attributs sont dans la structure <code>A</code></li>
<li>les méthodes de la classe seront implémentées par des fonctions C</li>
<li>les pointeurs sur ces fonctions seront dans la métaclasse de <code>A</code></li>
<li>Tous les objets de la classe <code>A</code> se partagent le pointeur sur sa métaclasse.</li>
</ul>

<h1 id="implémentation-dun-objet-24">Implémentation d&#39;un objet (2/4)</h1>

<p>La création d&#39;un nouvel objet (par <code>new</code> en <em>Toy</em>) provoque
l&#39;exécution du <strong>constructeur</strong> de la classe.</p>

<pre><code class="hl java"><span class="hl kwa">int</span> <span class="hl kwd">main</span> <span class="hl opt">() {</span>
   A a <span class="hl opt">=</span> <span class="hl kwa">new</span> A<span class="hl opt">;</span>
   <span class="hl opt">...</span>
<span class="hl opt">}</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c"><span class="hl kwb">int</span> <span class="hl kwd">main</span><span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">) {</span>
  A a <span class="hl opt">=</span> <span class="hl kwd">_init_A</span><span class="hl opt">(</span><span class="hl kwd">_toy_allocate_object</span><span class="hl opt">(</span><span class="hl kwa">sizeof</span><span class="hl opt">(</span><span class="hl kwb">struct</span> A<span class="hl opt">)));</span>
  <span class="hl opt">...</span>
<span class="hl opt">}</span>
</code></pre>

<ul>
<li><p><strong>_toy_allocate_object</strong> n&#39;est qu&#39;un <em>wrapper</em> autour de la fonction <em>malloc</em>.</p></li>
<li><p>Le constructeur de la classe s&#39;appelle <code>_init_A</code></p></li>
<li><p>Il prend en paramètre la zone mémoire qui vient d&#39;être allouée.</p></li>
</ul>

<h1 id="implémentation-dun-objet-34">Implémentation d&#39;un objet (3/4)</h1>

<p>Le <strong>constructeur</strong> produit par le compilateur pour la classe <code>A</code>:</p>

<pre><code class="hl c"><span class="hl num">1</span><span class="hl opt">:</span> <span class="hl slc">// Class constructor for A</span>
<span class="hl num">2</span><span class="hl opt">:</span> A <span class="hl kwd">_init_A</span><span class="hl opt">(</span>A <span class="hl kwa">this</span><span class="hl opt">) {</span>
<span class="hl num">3</span><span class="hl opt">:</span>    <span class="hl kwd">_init_Object</span><span class="hl opt">((</span>Object<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
<span class="hl num">4</span><span class="hl opt">:</span>    <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>_instance_of <span class="hl opt">= &amp;</span>_toy_meta_A<span class="hl opt">;</span>
<span class="hl num">5</span><span class="hl opt">:</span>
<span class="hl num">6</span><span class="hl opt">:</span>    <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>A_x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
<span class="hl num">7</span><span class="hl opt">:</span>    <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl num">8</span><span class="hl opt">: }</span>
</code></pre>

<p>On voit que:</p>

<ul>
<li><p><strong>ligne 3</strong>: on appelle le constructeur de la classe parente pour initialiser
<strong>this</strong> (ici la classe <em>Object</em>)</p></li>
<li><p><strong>ligne 4</strong> initialisation de la métaclasse de <strong>this</strong> à l&#39;objet décrivant la classe <code>A</code></p></li>
<li><p><strong>ligne 6</strong>: Initialisation des champs de l&#39;objet à leur valeur par défaut (ici un seul champ: <strong>x</strong>).</p></li>
</ul>

<h1 id="implémentation-dun-objet-44">Implémentation d&#39;un objet (4/4)</h1>

<p><strong>Héritage</strong>: Voyons ce que cela donne:</p>

<pre><code class="hl java"><span class="hl kwa">class</span> B <span class="hl kwa">extends</span> A <span class="hl opt">{</span>
    <span class="hl kwa">int</span> x<span class="hl opt">,</span> y<span class="hl opt">;</span>
    <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwa">int</span> i<span class="hl opt">) {</span> x <span class="hl opt">=</span> y <span class="hl opt">=</span> <span class="hl num">2</span> <span class="hl opt">*</span>i<span class="hl opt">; }</span>
<span class="hl opt">}</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c">B <span class="hl kwd">_init_B</span><span class="hl opt">(</span>B <span class="hl kwa">this</span><span class="hl opt">) {</span>        <span class="hl slc">// B default class constructor impl.</span>
  <span class="hl kwd">_init_A</span><span class="hl opt">((</span>A<span class="hl opt">)</span> <span class="hl kwa">this</span><span class="hl opt">);</span>
  <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>_instance_of <span class="hl opt">= &amp;</span>_toy_meta_B<span class="hl opt">;</span>

  <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>B_x <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>B_y <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>
  <span class="hl kwa">return this</span><span class="hl opt">;</span>
<span class="hl opt">}</span>

<span class="hl kwb">void</span> <span class="hl kwd">_B_f</span><span class="hl opt">(</span>B <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwb">int</span> i<span class="hl opt">) {</span>   <span class="hl slc">// Method B::f implementation</span>
  <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>B_x <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">-&gt;</span>B_y <span class="hl opt">=</span> <span class="hl num">2</span> <span class="hl opt">*</span> i<span class="hl opt">;</span>
<span class="hl opt">}</span>
</code></pre>

<h1 id="implémentation-des-méthodes-12">Implémentation des méthodes (1/2)</h1>

<p>Les méthodes:</p>

<ul>
<li>sont implémentées par des fonctions en C</li>
<li>la liste de paramètres de la fonction C
<ul>
<li>a toujours un premier paramètre
<ul>
<li>de nom <strong>this</strong></li>
<li>du type de la classe où la méthode est définie</li>
</ul></li>
<li>les autres paramètres (et le type de retour) sont identiques à
la méthode qu&#39;elle implémente.</li>
</ul></li>
</ul>

<pre><code class="hl java"><span class="hl kwa">class</span> A <span class="hl opt">{</span> <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwa">int</span> i<span class="hl opt">) {</span> <span class="hl kwd">print</span><span class="hl opt">(</span>i<span class="hl opt">); } }</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c"><span class="hl kwb">void</span> <span class="hl kwd">_A_f</span><span class="hl opt">(</span>A <span class="hl kwa">this</span><span class="hl opt">,</span> <span class="hl kwb">int</span> i<span class="hl opt">) {</span>
  <span class="hl opt">{</span>
    <span class="hl kwd">printf</span><span class="hl opt">(</span><span class="hl str">&quot;%d&quot;</span><span class="hl opt">,</span> i<span class="hl opt">);</span>
    <span class="hl kwd">fflush</span><span class="hl opt">(</span>stdout<span class="hl opt">);</span>
  <span class="hl opt">}</span>
<span class="hl opt">}</span>
</code></pre>

<h1 id="implémentation-des-méthodes-22">Implémentation des méthodes (2/2)</h1>

<p>La liste des méthodes d&#39;une classe est placée dans sa métaclasse:</p>

<ul>
<li>est ordonnée. Elle contient:
<ul>
<li>les méthodes héritées
<strong>PUIS</strong></li>
<li>les méthodes de la classe</li>
</ul></li>
<li>elle permet de <strong>numéroter les méthodes</strong> de la classe</li>
<li><strong>l&#39;ordre doit être pérenne</strong> lorsqu&#39;on a de l&#39;héritage (<em>polymorphisme</em>)</li>
</ul>

<pre><code class="hl java"><span class="hl kwa">class</span> A <span class="hl opt">{</span>
 <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">() { ... }</span>
 <span class="hl kwa">void</span> <span class="hl kwd">g</span><span class="hl opt">() { ... }</span>

<span class="hl kwa">class</span> B <span class="hl kwa">extends</span> A <span class="hl opt">{</span>
  <span class="hl kwa">void</span> <span class="hl kwd">h</span><span class="hl opt">() { ... }</span>
  <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">() { ... }</span>
<span class="hl opt">}</span>
</code></pre>

<p>Dans la classe <code>B</code>, la liste de méthodes que l&#39;on peut appeler:</p>

<blockquote>
<blockquote>
<p><strong>0</strong> - <code>printobj</code> (héritée de Objet)
<strong>1</strong> - <code>typename</code> (héritée de Objet)
<strong>2</strong> - <code>f</code> (attention <strong>celle de B</strong>, car surcharge)
<strong>3</strong> - <code>g</code> (héritée de A)
<strong>4</strong> - <code>h</code> (celle de B)</p>
</blockquote>
</blockquote>

<h1 id="table-des-méthodes-virtuelles-12">Table des méthodes virtuelles (1/2)</h1>

<p>On reprend les définitions précédentes:</p>

<pre><code class="hl java"><span class="hl kwa">class</span> A <span class="hl opt">{</span>
 <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">() { ... }</span>
 <span class="hl kwa">void</span> <span class="hl kwd">g</span><span class="hl opt">() { ... }</span>

<span class="hl kwa">class</span> B <span class="hl kwa">extends</span> A <span class="hl opt">{</span>
  <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">() { ... }</span>
  <span class="hl kwa">void</span> <span class="hl kwd">h</span><span class="hl opt">() { ... }</span>
<span class="hl opt">}</span>
</code></pre>

<p>La métaclasse de B est donc représentée par la structure C suivante:</p>

<pre><code class="hl c">toy_metaclass _toy_meta_B <span class="hl opt">= {</span>
     <span class="hl opt">.</span>classname    <span class="hl opt">=</span> <span class="hl str">&quot;B&quot;</span><span class="hl opt">,</span>
     <span class="hl opt">.</span>extends_meta <span class="hl opt">= &amp;</span>_toy_meta_A<span class="hl opt">,</span>
     <span class="hl opt">.</span>methods      <span class="hl opt">= {</span>
        _Object_printobj<span class="hl opt">,</span>
        _Object_typename<span class="hl opt">,</span>
        _B_f<span class="hl opt">,</span>
        _A_g<span class="hl opt">,</span>
        _B_h<span class="hl opt">}</span>
<span class="hl opt">};</span>
</code></pre>

<h1 id="table-des-méthodes-virtuelles-22">Table des méthodes virtuelles (2/2)</h1>

<p>La table des méthodes virtuelles est construite durant la phase
d&#39;analyse de la classe.</p>

<p><strong>Principe de l&#39;algorithme</strong>:</p>

<ul>
<li><p>Descendre la hiérarchie d&#39;héritage et construire la liste <strong>M</strong> des
méthodes définies:</p>

<ul>
<li>(<code>Object::printobj</code>, <code>Object::typename</code>, <code>A::f</code>, <code>A::g</code>, <code>B::h</code>, <code>B::f</code>)</li>
</ul></li>
<li><p>créer une liste vide <strong>L</strong></p></li>
<li><p>Parcourir la liste <strong>M</strong> de la gauche vers la droite et pour chaque item
de la forme α::β</p>

<ul>
<li>si ∃ un item de la forme χ::β à sa droite dans <strong>M</strong>,
<ul>
<li>placer χ::β dans <strong>L</strong></li>
<li>sinon placer α::β dans <strong>L</strong></li>
</ul></li>
<li>ne rien faire si α::β est déjà dans <strong>L</strong></li>
</ul></li>
</ul>

<p>On obtient donc ici:</p>

<ul>
<li>(<code>Object::printobj</code>, <code>Object::typename</code>, <code>B::f</code>, <code>A::g</code>, <code>B::h</code>)</li>
</ul>

<h1 id="appel-de-méthodes-12">Appel de méthodes (1/2)</h1>

<p>Les méthodes:</p>

<ul>
<li>sont numérotées</li>
<li>sont accessibles dans la table des méthodes virtuelles (<strong>methods</strong>)
de la classe.</li>
</ul>

<p>Lors de <strong>l&#39;analyse</strong> d&#39;un appel, vérifier que la méthode est bien
accessible depuis la classe où la méthode est définie.</p>

<p>Lors de la production de code d&#39;un appel de la forme <code>a.f(10)</code> il faut</p>

<ul>
<li>trouver le numéro <code>n</code> de la méthode <code>f</code> (ici c&#39;est <code>2</code>)</li>
<li>appeler la méthode <code>n</code> dans la table <em>methods</em> de la métaclasse de <code>a</code></li>
<li>passer <code>a</code> comme premier paramètre de la fonction trouvée (<strong>this</strong>)</li>
</ul>

<p>On a donc:</p>

<pre><code class="hl c">  a<span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">10</span><span class="hl opt">);</span>                              <span class="hl slc">// en Toy</span>

  ⟹

  a<span class="hl opt">-&gt;</span>instance_of<span class="hl opt">.</span>methods<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">](</span>a<span class="hl opt">,</span> <span class="hl num">10</span><span class="hl opt">);</span>     <span class="hl slc">// en C</span>
</code></pre>

<h1 id="appel-de-méthodes-22">Appel de méthodes (2/2)</h1>

<pre><code class="hl java"><span class="hl kwa">class</span> A           <span class="hl opt">{</span> <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwa">int</span> i<span class="hl opt">) { };</span>    <span class="hl kwa">void</span> <span class="hl kwd">g</span><span class="hl opt">() { } }</span>
<span class="hl kwa">class</span> B <span class="hl kwa">extends</span> A <span class="hl opt">{</span> <span class="hl kwa">void</span> <span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl kwa">int</span> i<span class="hl opt">) { };</span>    <span class="hl kwa">void</span> <span class="hl kwd">h</span><span class="hl opt">() { } }</span>
<span class="hl opt">...</span>
A a <span class="hl opt">=</span> <span class="hl kwa">new</span> A<span class="hl opt">;</span>
B b <span class="hl opt">=</span> <span class="hl kwa">new</span> B<span class="hl opt">;</span>

a<span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
b<span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">);</span>
<span class="hl kwa">if</span> <span class="hl opt">(</span>ok<span class="hl opt">)</span> a <span class="hl opt">=</span> b<span class="hl opt">;</span>
a<span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">12</span><span class="hl opt">);</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c">A a <span class="hl opt">=</span> <span class="hl kwd">_init_A</span><span class="hl opt">(</span>toy_allocate_<span class="hl opt">...)</span>
B b <span class="hl opt">=</span> <span class="hl kwd">_init_B</span><span class="hl opt">(</span>toy_allocate_<span class="hl opt">...)</span>

a<span class="hl opt">-&gt;</span>instance_of<span class="hl opt">.</span>methods<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">](</span>a<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>    <span class="hl slc">// Appel de A::f (numéro 2)</span>
b<span class="hl opt">-&gt;</span>instance_of<span class="hl opt">.</span>methods<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">](</span>b<span class="hl opt">,</span> <span class="hl num">1</span><span class="hl opt">);</span>    <span class="hl slc">// Appel de B::f (numéro 2)</span>
<span class="hl kwa">if</span> <span class="hl opt">(</span>ok<span class="hl opt">)</span>
  a <span class="hl opt">= (</span>A<span class="hl opt">)(</span>b<span class="hl opt">);</span>
a<span class="hl opt">-&gt;</span>instance_of<span class="hl opt">.</span>methods<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">](</span>a<span class="hl opt">,</span> <span class="hl num">12</span><span class="hl opt">);</span>   <span class="hl slc">// Appel méthode numéro 2 accessible depuis a</span>
</code></pre>

<h1 id="variables-temporaires-14">Variables temporaires (1/4)</h1>

<dl>
<dt><strong>Problème:</strong></dt>
<dd>En pratique, l&#39;accès à un attribut d&#39;objet n&#39;est pas aussi simple.</dd>
</dl>

<p>En effet, dans le cas général, pour</p>

<pre><code class="hl c">    a<span class="hl opt">.</span>x
</code></pre>

<p>on ne peut pas produire</p>

<pre><code class="hl c">    a<span class="hl opt">-&gt;</span>A_x<span class="hl opt">;</span>
</code></pre>

<p>car le préfixe de <code>x</code> peut être arbitrairement complexe:</p>

<pre><code class="hl c">   x<span class="hl opt">.</span><span class="hl kwd">g</span><span class="hl opt">(...).</span>x
</code></pre>

<p>Ce code provoquerait 2 appels à la méthode <code>g</code> (qui peut avoir des effets de
bords).</p>

<p>Il faudrait donc produire:</p>

<pre><code class="hl c">    <span class="hl opt">{</span>
      A tmp <span class="hl opt">=</span> x<span class="hl opt">.</span><span class="hl kwd">g</span><span class="hl opt">(...);</span>
      tmp<span class="hl opt">-&gt;</span>A_x<span class="hl opt">;</span>
    <span class="hl opt">}</span>
</code></pre>

<h1 id="variables-temporaires-24">Variables temporaires (2/4)</h1>

<p>Mais on peut être amené à produire plusieurs variables temporaires.</p>

<p>Soit</p>

<pre><code class="hl java">x<span class="hl opt">.</span><span class="hl kwd">g</span><span class="hl opt">(...).</span>x <span class="hl opt">=</span> z<span class="hl opt">.</span><span class="hl kwd">h</span><span class="hl opt">(...).</span>y<span class="hl opt">;</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c">    <span class="hl opt">{</span>
      A tmp <span class="hl opt">=</span> x<span class="hl opt">.</span><span class="hl kwd">g</span><span class="hl opt">(...);</span>
      tmp<span class="hl opt">-&gt;</span> A_x<span class="hl opt">;</span>
    <span class="hl opt">} = {</span>
          B tmp <span class="hl opt">=</span> z<span class="hl opt">.</span><span class="hl kwd">h</span><span class="hl opt">(...);</span>
          tmp<span class="hl opt">-&gt;</span>B_y<span class="hl opt">;</span>
        <span class="hl opt">}</span>
</code></pre>

<p>ne marche pas en C car les blocs ne renvoient pas de valeur.</p>

<p>On doit donc produire quelque chose comme:</p>

<pre><code class="hl c">    <span class="hl opt">{</span>
       A tmp1 <span class="hl opt">=</span> x<span class="hl opt">.</span><span class="hl kwd">g</span><span class="hl opt">(...);</span>
       B tmp2 <span class="hl opt">=</span> z<span class="hl opt">.</span><span class="hl kwd">h</span><span class="hl opt">(...);</span>
       tmp1<span class="hl opt">-&gt;</span>A_x <span class="hl opt">=</span> tmp2<span class="hl opt">-&gt;</span>y<span class="hl opt">;</span>
    <span class="hl opt">}</span>
</code></pre>

<h1 id="variables-temporaires-34">Variables temporaires (3/4)</h1>

<p>Si on produit des temporaires, il faut en minimiser le nombre:</p>

<ul>
<li>On peut déclarer toutes les temporaires de type <code>Object</code></li>
<li>Au moment de l&#39;affectation on fait un cast en <code>Object</code></li>
<li>Il faut faire un passage sur l&#39;arbre pour déterminer le nombre de
temporaires nécessaires.</li>
</ul>

<p>Cela complique notablement la production de code.</p>

<p>GCC propose une extension qui permet de transformet des blocs en
expressions (CLANG dispose aussi de cette extension).</p>

<p>Exemple d&#39;utilisation: la macro suivante:</p>

<pre><code class="hl c">     <span class="hl ppc">#define max(a,b) ((a) &gt; (b) ? (a) : (b))</span>
</code></pre>

<p>évalue 2 fois <code>a</code> ou <code>b</code> (ce qui peut être génant si il y a des effets de bord).</p>

<p>Elle peut être réécrite en :</p>

<pre><code class="hl c">     <span class="hl ppc">#define maxint(a,b) \</span>
<span class="hl ppc">       ({int _a = (a), _b = (b); _a &gt; _b ? _a : _b; })</span>
</code></pre>

<h1 id="variables-temporaires-44">Variables temporaires (4/4)</h1>

<p>Soit</p>

<pre><code class="hl java">x<span class="hl opt">.</span><span class="hl kwd">g</span><span class="hl opt">(...).</span>x <span class="hl opt">=</span> z<span class="hl opt">.</span><span class="hl kwd">h</span><span class="hl opt">(...).</span>y<span class="hl opt">;</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c">    <span class="hl opt">({</span> A tmp <span class="hl opt">=</span> x<span class="hl opt">.</span><span class="hl kwd">g</span><span class="hl opt">(...);</span> tmp<span class="hl opt">-&gt;</span> A_x<span class="hl opt">;}) =</span>
                 <span class="hl opt">({</span> B tmp <span class="hl opt">=</span> z<span class="hl opt">.</span><span class="hl kwd">h</span><span class="hl opt">(...);</span> tmp<span class="hl opt">-&gt;</span>B_y<span class="hl opt">;} )</span>
</code></pre>

<p>Pour simplifier le code produit; on passe par des macros (définies dans <code>toy_runtime.h</code>).</p>

<p>On dispose principalement de 2 macros:</p>

<ul>
<li><p><code>_TOY_ACCESS(_obj, _klass)</code> est utilisée pour accéder à un attribut d&#39;une instance <code>_obj</code> de la classe <code>_klass</code></p></li>
<li><p><code>_TOY_INVOKE(_type, _obj, _idx, ...)</code> permet l&#39;appel de la méthode de numéro <code>_idx</code> de l&#39;objet <code>_obj</code></p></li>
</ul>

<p>De plus, ces macros vérifient que l&#39;objet <code>_obj</code> n&#39;est pas NULL et
déclenchent une erreur sinon.</p>

<h1 id="exemples-de-code-produit-13">Exemples de code produit (1/3)</h1>

<p>Soit</p>

<pre><code class="hl java">   a<span class="hl opt">.</span>x <span class="hl opt">=</span> b<span class="hl opt">.</span>y<span class="hl opt">;</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c">   <span class="hl kwd">_TOY_ACCESS</span><span class="hl opt">(</span>a<span class="hl opt">,</span>A<span class="hl opt">)-&gt;</span>A_x <span class="hl opt">=</span> <span class="hl kwd">_TOY_ACCESS</span><span class="hl opt">(</span>b<span class="hl opt">,</span>B<span class="hl opt">)-&gt;</span>B_y<span class="hl opt">;</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c"><span class="hl opt">({</span> A _tmp_ <span class="hl opt">=</span> a<span class="hl opt">;</span>
   <span class="hl kwa">if</span> <span class="hl opt">(!</span> _tmp_<span class="hl opt">)</span> <span class="hl kwd">_toy_nullaccess</span><span class="hl opt">(</span><span class="hl str">&quot;foo.c&quot;</span><span class="hl opt">,</span> <span class="hl num">102</span><span class="hl opt">);</span>
   _tmp_<span class="hl opt">;})-&gt;</span>A_x <span class="hl opt">=</span>
<span class="hl opt">({</span> B _tmp_ <span class="hl opt">=</span> b<span class="hl opt">;</span>
   <span class="hl kwa">if</span> <span class="hl opt">(!</span> _tmp_<span class="hl opt">)</span> <span class="hl kwd">_toy_nullaccess</span><span class="hl opt">(</span><span class="hl str">&quot;foo.c&quot;</span><span class="hl opt">,</span> <span class="hl num">102</span><span class="hl opt">);</span>
   _tmp_<span class="hl opt">;})-&gt;</span>B_y<span class="hl opt">;</span>
</code></pre>

<h1 id="exemples-de-code-produit-23">Exemples de code produit (2/3)</h1>

<p>Soit</p>

<pre><code class="hl java">   a<span class="hl opt">.</span><span class="hl kwd">f</span><span class="hl opt">(</span><span class="hl num">1234</span><span class="hl opt">);</span>     <span class="hl slc">// f est une méthode de type void</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c">   <span class="hl kwd">_TOY_INVOKE</span><span class="hl opt">(</span><span class="hl kwb">void</span><span class="hl opt">,</span> a<span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">,</span> _this<span class="hl opt">,</span> <span class="hl num">1234</span><span class="hl opt">);</span>  <span class="hl slc">// Indice fonction = 2</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c"><span class="hl opt">({</span> Object _this <span class="hl opt">= (</span>Object<span class="hl opt">)</span> a<span class="hl opt">;</span>
   <span class="hl kwa">if</span> <span class="hl opt">(!</span> _this<span class="hl opt">)</span> <span class="hl kwd">_toy_nullaccess</span><span class="hl opt">(</span><span class="hl str">&quot;foo.c&quot;</span><span class="hl opt">,</span> <span class="hl num">102</span><span class="hl opt">);</span>
   <span class="hl opt">((</span><span class="hl kwb">void</span> <span class="hl opt">(*)()) (</span>_this<span class="hl opt">-&gt;</span>_instance_of<span class="hl opt">-&gt;</span>methods<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]))(</span>_this<span class="hl opt">,</span> <span class="hl num">1234</span><span class="hl opt">);})</span>
</code></pre>

<h1 id="exemples-de-code-produit-33">Exemples de code produit (3/3)</h1>

<pre><code class="hl java">    a<span class="hl opt">.</span><span class="hl kwd">g</span><span class="hl opt">().</span>x <span class="hl opt">=</span> b<span class="hl opt">.</span><span class="hl kwd">h</span><span class="hl opt">().</span>y<span class="hl opt">;</span>    <span class="hl slc">// g renvoit un A et h un B</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c">    <span class="hl kwd">_TOY_ACCESS</span><span class="hl opt">(</span><span class="hl kwd">_TOY_INVOKE</span><span class="hl opt">(</span>A<span class="hl opt">,</span> a<span class="hl opt">,</span> <span class="hl num">3</span><span class="hl opt">,</span> _this<span class="hl opt">),</span>A<span class="hl opt">)-&gt;</span>A_x <span class="hl opt">=</span>
    <span class="hl kwd">_TOY_ACCESS</span><span class="hl opt">(</span><span class="hl kwd">_TOY_INVOKE</span><span class="hl opt">(</span>B<span class="hl opt">,</span> b<span class="hl opt">,</span> <span class="hl num">4</span><span class="hl opt">,</span> _this<span class="hl opt">),</span>B<span class="hl opt">)-&gt;</span>B_y<span class="hl opt">;</span>
</code></pre>

<p>⟹</p>

<pre><code class="hl c">  <span class="hl opt">({</span> A _tmp_ <span class="hl opt">= ({</span> Object _this <span class="hl opt">= (</span>Object<span class="hl opt">)</span> a<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span> _this<span class="hl opt">)</span> <span class="hl kwd">_toy_nullaccess</span><span class="hl opt">(</span><span class="hl str">&quot;foo.c&quot;</span><span class="hl opt">,</span> <span class="hl num">102</span><span class="hl opt">);</span>
        <span class="hl opt">((</span><span class="hl kwd">A</span> <span class="hl opt">(*)())(</span>_this<span class="hl opt">-&gt;</span>_instance_of<span class="hl opt">-&gt;</span>methods<span class="hl opt">[</span><span class="hl num">3</span><span class="hl opt">]))(</span>_this<span class="hl opt">);});</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span> _tmp_<span class="hl opt">)</span> <span class="hl kwd">_toy_nullaccess</span><span class="hl opt">(</span><span class="hl str">&quot;foo.c&quot;</span><span class="hl opt">,</span> <span class="hl num">102</span><span class="hl opt">);</span> _tmp_<span class="hl opt">; })-&gt;</span>A_x <span class="hl opt">=</span>
  <span class="hl opt">({</span> B _tmp_ <span class="hl opt">= ({</span> Object _this <span class="hl opt">= (</span>Object<span class="hl opt">)</span> b<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span> _this<span class="hl opt">)</span> <span class="hl kwd">_toy_nullaccess</span><span class="hl opt">(</span><span class="hl str">&quot;foo.c&quot;</span><span class="hl opt">,</span> <span class="hl num">102</span><span class="hl opt">);</span>
        <span class="hl opt">((</span><span class="hl kwd">B</span> <span class="hl opt">(*)())(</span>_this<span class="hl opt">-&gt;</span>_instance_of<span class="hl opt">-&gt;</span>methods<span class="hl opt">[</span><span class="hl num">4</span><span class="hl opt">]))(</span>_this<span class="hl opt">);});</span>
    <span class="hl kwa">if</span> <span class="hl opt">(!</span> _tmp_<span class="hl opt">)</span> <span class="hl kwd">_toy_nullaccess</span><span class="hl opt">(</span><span class="hl str">&quot;foo.c&quot;</span><span class="hl opt">,</span> <span class="hl num">102</span><span class="hl opt">);</span> _tmp_<span class="hl opt">; })-&gt;</span>B_y<span class="hl opt">;</span>

</code></pre>

<p>Intérêt des macros:</p>

<ul>
<li>code plus facile à produire;</li>
<li>(accessoirement) code produit plus lisible;</li>
<li>possibilité de désactiver les contôles lorsque le programme est testé.</li>
</ul>

<h1 id="gestion-des-désignations-13">Gestion des désignations (1/3)</h1>

<p><strong>Syntaxe des désignation de Toy:</strong></p>

<pre><code class="hl bison"><span class="hl kwd">expr:</span>           ...
                designator
                ...

<span class="hl kwd">var:</span>            identifier
        |       designator <span class="hl str">&apos;.&apos;</span> identifier
        <span class="hl opt">;</span>

<span class="hl kwd">call:</span>           var <span class="hl str">&apos;(&apos;</span> eparam_list <span class="hl str">&apos;)&apos;</span>
        <span class="hl opt">;</span>

<span class="hl kwd">designator:</span>     var
        |       call
        |       KNEW identifier
        |       KTHIS
        |       KSUPER
        <span class="hl opt">;</span>
</code></pre>

<p>Avec l&#39;introduction des objets dans Toy, on peut avoir:</p>

<ul>
<li><code>a.b.p(i,c.k).d.q().x</code></li>
<li><code>this.a</code></li>
<li><code>super.b</code></li>
<li><code>new A.init(1, 2, 3)</code></li>
</ul>

<h1 id="gestion-des-désignations-23">Gestion des désignations (2/3)</h1>

<p>Au niveau syntaxique, pour implémenter les désignations, on ne fait qu&#39;ajouter le préfixe à l&#39;identificateur.</p>

<p>Ainsi, on a:</p>

<pre><code class="hl bison"><span class="hl kwd">var:</span>       identifier
                     <span class="hl opt">{</span> $$ <span class="hl opt">=</span> make_identifier<span class="hl opt">(</span><span class="hl kwc">$1</span><span class="hl opt">); }</span>
        |   designator <span class="hl str">&apos;.&apos;</span> identifier
                     <span class="hl opt">{</span> $$ <span class="hl opt">=</span> add_prefix_to_identifier<span class="hl opt">(</span><span class="hl kwc">$3</span><span class="hl opt">,</span> <span class="hl kwc">$1</span><span class="hl opt">);}</span>
        <span class="hl opt">;</span>
</code></pre>

<p>Lorsqu&#39;un identificateur est préfixé, le préfixe sera donc</p>

<ul>
<li>accessible depuis l&#39;identificateur le plus à droite (de proche en proche)</li>
<li>typé lors de l&#39;analyse sémantique (avec vérification que
l&#39;identificateur situé à droite est bien un membre du préfixe).</li>
</ul>

<h1 id="gestion-des-désignations-33">Gestion des désignations (3/3)</h1>

<p>Suite des règles sur les désignations:</p>

<pre><code class="hl bison"><span class="hl kwd">call:</span>           var <span class="hl str">&apos;(&apos;</span> eparam_list <span class="hl str">&apos;)&apos;</span>
                                <span class="hl opt">{</span> $$ <span class="hl opt">=</span> make_call<span class="hl opt">(</span><span class="hl kwc">$1</span><span class="hl opt">,</span> <span class="hl kwc">$3</span><span class="hl opt">); }</span>
        <span class="hl opt">;</span>

<span class="hl kwd">designator:</span>     var             <span class="hl opt">{</span> $$ <span class="hl opt">=</span> <span class="hl kwc">$1</span><span class="hl opt">; }</span>
        |       call            <span class="hl opt">{</span> $$ <span class="hl opt">=</span> <span class="hl kwc">$1</span><span class="hl opt">; }</span>
        |       KNEW identifier <span class="hl opt">{</span> $$ <span class="hl opt">=</span> make_instance_new<span class="hl opt">(</span>
                                        make_type<span class="hl opt">(</span><span class="hl kwc">$2</span><span class="hl opt">,</span> <span class="hl str">&quot;NULL&quot;</span><span class="hl opt">));}</span>
        |       KTHIS           <span class="hl opt">{</span> $$ <span class="hl opt">=</span> make_this<span class="hl opt">(); }</span>
        |       KSUPER          <span class="hl opt">{</span> $$ <span class="hl opt">=</span> make_super<span class="hl opt">(); }</span> <span class="hl slc">// ABSENT</span>
        <span class="hl opt">;</span>
</code></pre>

<p>Ces règles permettent donc bien la construction de l&#39;AST pour</p>

<ul>
<li><code>a.b.p(i,c.k).d.q().x</code></li>
<li><code>this.a</code></li>
<li><code>super.b</code></li>
<li><code>new A.init(1, 2, 3)</code></li>
</ul>

<h1 id="désignations-et-arbre-abstrait-13">Désignations et arbre abstrait (1/3)</h1>

<p>Pour représenter un identificateur dans l&#39;arbre:</p>

<p><strong>En <em>Toy base</em>:</strong></p>

<pre><code class="hl c"><span class="hl kwb">struct</span> s_identifier <span class="hl opt">{</span>
  ast_node header<span class="hl opt">;</span>  <span class="hl slc">///&lt; AST header</span>
  <span class="hl kwb">char</span> <span class="hl opt">*</span>value<span class="hl opt">;</span>      <span class="hl slc">///&lt; value of the identifier (a string)</span>
<span class="hl opt">};</span>

ast_node <span class="hl opt">*</span><span class="hl kwd">make_identifier</span><span class="hl opt">(</span><span class="hl kwb">char</span> <span class="hl opt">*</span>id<span class="hl opt">);</span>
</code></pre>

<p><strong>En <em>Toy</em>:</strong></p>

<pre><code class="hl c"><span class="hl kwb">struct</span> s_identifier <span class="hl opt">{</span>
  ast_node header<span class="hl opt">;</span>      <span class="hl slc">///&lt; AST header</span>
  <span class="hl kwb">char</span> <span class="hl opt">*</span>value<span class="hl opt">;</span>          <span class="hl slc">///&lt; value of the identifier (a string)</span>
  ast_node <span class="hl opt">*</span>in_class<span class="hl opt">;</span>   <span class="hl slc">///&lt; Embedding class for attributes or NULL</span>
  ast_node <span class="hl opt">*</span>prefix<span class="hl opt">;</span>     <span class="hl slc">///&lt; prefix of the identifier (or NULL)</span>
  ast_node <span class="hl opt">*</span>qualified<span class="hl opt">;</span>  <span class="hl slc">///&lt;  &apos;prefix.ident&apos; object after analysis.</span>
<span class="hl opt">};</span>

ast_node <span class="hl opt">*</span><span class="hl kwd">make_identifier</span><span class="hl opt">(</span><span class="hl kwb">char</span> <span class="hl opt">*</span>id<span class="hl opt">);</span>
ast_node <span class="hl opt">*</span><span class="hl kwd">add_prefix_to_identifier</span><span class="hl opt">(</span>ast_node <span class="hl opt">*</span>ident<span class="hl opt">,</span>
                                   ast_node <span class="hl opt">*</span>prefix<span class="hl opt">);</span>
</code></pre>

<h1 id="désignations-et-arbre-abstrait-23">Désignations et arbre abstrait (2/3)</h1>

<p>Trois nouveaux champs:</p>

<ul>
<li><p><strong>prefix</strong>: contient l&#39;arbre syntaxique.<br>
Si on a <code>x.y.z</code></p>

<ul>
<li>z est présent dans l&#39;arbre</li>
<li>le préfixe de z est l&#39;identificateur y (qui a comme préfixe x)</li>
</ul>

<p>Si on a <code>this.x</code></p>

<ul>
<li>x est présent dans l&#39;arbre</li>
<li>son préfixe est un nœud de type <code>this</code>.</li>
</ul></li>
<li><p><strong>in_class</strong>: contient un pointeur sur la classe de définition d&#39;un champ
Ce champ sert principalement à la production de code:<br>
Si on a: <code>c.x</code> on produit <code>_TOY_ACCESS(c,C)-&gt;_A_x)</code></p>

<ul>
<li>si <code>c</code> est de type C</li>
<li>si <code>x</code> est déclaré dans la classe <code>A</code> héritée par <code>C</code></li>
</ul></li>
<li><p><strong>qualified</strong>: pourrait être omis.<br>
Utilisé pour éviter plusieurs recherches dans la table des symboles.</p></li>
</ul>

<h1 id="désignations-et-arbre-abstrait-23-1">Désignations et arbre abstrait (2/3)</h1>

<p>Les préfixes sont construit lors de la phase d&#39;analyse syntaxique.</p>

<p>Le compilateur peut aussi introduire des préfixes lors de l&#39;analyse.</p>

<pre><code class="hl java"><span class="hl kwa">class</span> B <span class="hl opt">{</span>
    <span class="hl kwa">int</span> x<span class="hl opt">;</span>
    A a<span class="hl opt">;</span>

    <span class="hl kwa">void</span> <span class="hl kwd">foo</span><span class="hl opt">() {</span>
      <span class="hl kwd">print</span><span class="hl opt">(</span>x<span class="hl opt">);</span>      <span class="hl slc">// équivalent this.x</span>
      <span class="hl kwd">print</span><span class="hl opt">(</span>a<span class="hl opt">.</span>z<span class="hl opt">);</span>    <span class="hl slc">// équivalent this.a.z</span>
    <span class="hl opt">}</span>
    <span class="hl opt">...</span>
<span class="hl opt">}</span>
</code></pre>

<p>Ici le compilateur</p>

<ul>
<li>doit introduire <strong>this</strong> dans le préfixe de <code>x</code> et de <code>a</code>.</li>
<li>produira du code pour accéder à
<ul>
<li>this-&gt;_B_x;</li>
<li>this-&gt;_B_a-&gt;_A_z</li>
</ul></li>
</ul>

<h1 id="analyse-dun-identificateur-préfixé">Analyse d&#39;un identificateur préfixé</h1>

<pre><code class="hl c"><span class="hl kwb">static void</span> <span class="hl kwd">prefix_analysis</span><span class="hl opt">(</span>ast_node <span class="hl opt">*</span>node<span class="hl opt">,</span> <span class="hl kwb">char</span> <span class="hl opt">*</span>id<span class="hl opt">){</span>
  <span class="hl kwd">analysis</span><span class="hl opt">(</span><span class="hl kwd">IDENT_PREFIX</span><span class="hl opt">(</span>node<span class="hl opt">));</span>

  ast_node <span class="hl opt">*</span>prefix_type <span class="hl opt">=</span> <span class="hl kwd">AST_TYPE</span><span class="hl opt">(</span><span class="hl kwd">IDENT_PREFIX</span><span class="hl opt">(</span>node<span class="hl opt">));</span>

  <span class="hl kwd">AST_TYPE</span><span class="hl opt">(</span>node<span class="hl opt">) =</span> NULL<span class="hl opt">;</span>        <span class="hl slc">// will be changed if no error</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span><span class="hl kwd">valid_type</span><span class="hl opt">(</span>prefix_type<span class="hl opt">))</span> <span class="hl kwa">return</span><span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">TYPE_IS_STANDARD</span><span class="hl opt">(</span>prefix_type<span class="hl opt">)) {</span>
    <span class="hl kwd">error_msg</span><span class="hl opt">(</span>node<span class="hl opt">,</span> <span class="hl str">&quot;prefix of &apos;%s&apos; is not a class instance&quot;</span><span class="hl opt">,</span> id<span class="hl opt">);</span>
    <span class="hl kwa">return</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Verify that the class has the given identifier as field</span>
  ast_node <span class="hl opt">*</span>member <span class="hl opt">=</span> <span class="hl kwd">symbol_table_search_member</span><span class="hl opt">(</span>id<span class="hl opt">,</span> <span class="hl kwd">TYPE_NAME</span><span class="hl opt">(</span>prefix_type<span class="hl opt">));</span>
  <span class="hl kwa">if</span> <span class="hl opt">(!</span>member<span class="hl opt">) {</span>
    <span class="hl kwd">error_msg</span><span class="hl opt">(</span>node<span class="hl opt">,</span> <span class="hl str">&quot;member does not exist in class &quot;</span><span class="hl opt">);</span>
    <span class="hl kwa">return</span><span class="hl opt">;</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Copy the class definition of member in the identifier</span>
  <span class="hl kwd">IDENT_IN_CLASS</span><span class="hl opt">(</span>node<span class="hl opt">) =</span> <span class="hl kwd">IDENT_IN_CLASS</span><span class="hl opt">(</span>member<span class="hl opt">);</span>
  <span class="hl slc">// Fill the member slot for further analyzes and type the node</span>
  <span class="hl kwd">IDENT_QUALIFIED</span><span class="hl opt">(</span>node<span class="hl opt">) =</span> member<span class="hl opt">;</span>
  <span class="hl kwd">AST_TYPE</span><span class="hl opt">(</span>node<span class="hl opt">)        =</span> <span class="hl kwd">AST_TYPE</span><span class="hl opt">(</span>member<span class="hl opt">);</span>
<span class="hl opt">}</span>
</code></pre>

<h1 id="dénotation-production-de-code">Dénotation: production de code</h1>

<p>Tout est dans la production de code d&#39;un identificateur.</p>

<pre><code class="hl c"><span class="hl kwb">void</span> <span class="hl kwd">produce_code_identifier</span><span class="hl opt">(</span>ast_node <span class="hl opt">*</span>node<span class="hl opt">){</span>
  ast_node<span class="hl opt">*</span> klass<span class="hl opt">=</span> <span class="hl kwd">IDENT_IN_CLASS</span><span class="hl opt">(</span>node<span class="hl opt">);</span>

  <span class="hl slc">// Produce prefix if there is one</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">IDENT_PREFIX</span><span class="hl opt">(</span>node<span class="hl opt">)) {</span>
    ast_node<span class="hl opt">*</span> prefix <span class="hl opt">=</span> <span class="hl kwd">IDENT_PREFIX</span><span class="hl opt">(</span>node<span class="hl opt">);</span>
    <span class="hl kwb">char</span><span class="hl opt">*</span> type       <span class="hl opt">=</span> <span class="hl kwd">TYPE_NAME</span><span class="hl opt">(</span><span class="hl kwd">AST_TYPE</span><span class="hl opt">(</span>prefix<span class="hl opt">));</span>
    <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;_TOY_ACCESS(&quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">code</span><span class="hl opt">(</span>prefix<span class="hl opt">);</span>
    <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;,%s)-&gt;&quot;</span><span class="hl opt">,</span> type<span class="hl opt">);</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// Produce code of the identifier</span>
  <span class="hl kwa">if</span> <span class="hl opt">(</span>klass<span class="hl opt">)</span> <span class="hl slc">// Add prefix if it&apos;s a field</span>
     <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;_%s_&quot;</span><span class="hl opt">,</span> <span class="hl kwd">IDENT_VAL</span><span class="hl opt">(</span><span class="hl kwd">CLASS_NAME</span><span class="hl opt">(</span>klass<span class="hl opt">)));</span>
  <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;%s&quot;</span><span class="hl opt">,</span> <span class="hl kwd">IDENT_VAL</span><span class="hl opt">(</span>node<span class="hl opt">));</span>
<span class="hl opt">}</span>
</code></pre>

<p>Si on a: <code>c.x</code> on produit <code>_TOY_ACCESS(c,C)-&gt;_A_x)</code> si</p>

<ul>
<li><code>c</code> est de type <code>C</code> et</li>
<li><code>x</code> est déclaré dans la classe <code>A</code> héritée par <code>C</code></li>
</ul>

<h1 id="appel-production-de-code-12">Appel: production de code (1/2)</h1>

<p>La même fonction gère les appels de fonctions et de méthodes:</p>

<pre><code class="hl c"><span class="hl kwb">void</span> <span class="hl kwd">produce_code_call</span><span class="hl opt">(</span>ast_node <span class="hl opt">*</span>node<span class="hl opt">) {</span>
  <span class="hl kwb">struct</span> s_call <span class="hl opt">*</span>n <span class="hl opt">= (</span><span class="hl kwb">struct</span> s_call <span class="hl opt">*)</span> node<span class="hl opt">;</span>
  <span class="hl kwb">int</span> comma <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwd">IDENT_PREFIX</span><span class="hl opt">(</span>n<span class="hl opt">-&gt;</span>callee<span class="hl opt">) ==</span> NULL<span class="hl opt">) {</span>    <span class="hl slc">// - Function call</span>
    <span class="hl kwd">code</span><span class="hl opt">(</span>n<span class="hl opt">-&gt;</span>callee<span class="hl opt">);</span> <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;(&quot;</span><span class="hl opt">);</span>
  <span class="hl opt">}</span>
  <span class="hl kwa">else</span> <span class="hl opt">{</span>                                    <span class="hl slc">// - Method call</span>
    <span class="hl slc">// Prochain slide ....</span>
  <span class="hl opt">}</span>

  <span class="hl slc">// produce the parameters</span>
  <span class="hl kwd">FORLIST</span><span class="hl opt">(</span>p<span class="hl opt">,</span> n<span class="hl opt">-&gt;</span>parameters<span class="hl opt">) {</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>comma<span class="hl opt">++)</span> <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;, &quot;</span><span class="hl opt">);</span>
    <span class="hl kwd">code_expr_cast</span><span class="hl opt">(</span><span class="hl kwd">list_item_data</span><span class="hl opt">(</span>p<span class="hl opt">));</span>
  <span class="hl opt">}</span>
  <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;)&quot;</span><span class="hl opt">);</span>
<span class="hl opt">}</span>
</code></pre>

<h1 id="appel-production-de-code-22">Appel: production de code (2/2)</h1>

<p>Le code pour les méthode est:</p>

<pre><code class="hl c"><span class="hl opt">{</span>
  ast_node <span class="hl opt">*</span>method <span class="hl opt">=</span> <span class="hl kwd">IDENT_QUALIFIED</span><span class="hl opt">(</span>n<span class="hl opt">-&gt;</span>callee<span class="hl opt">);</span>

  <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;_TOY_INVOKE(&quot;</span><span class="hl opt">);</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl kwd">AST_TYPE</span><span class="hl opt">(</span>method<span class="hl opt">));</span> <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;, &quot;</span><span class="hl opt">);</span>   <span class="hl slc">// Result type</span>
  <span class="hl kwd">code</span><span class="hl opt">(</span><span class="hl kwd">IDENT_PREFIX</span><span class="hl opt">(</span>n<span class="hl opt">-&gt;</span>callee<span class="hl opt">));</span>        <span class="hl slc">// this</span>
  <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;, %d&quot;</span><span class="hl opt">,</span> <span class="hl kwd">FUNCTION_INDEX</span><span class="hl opt">(</span>method<span class="hl opt">));</span> <span class="hl slc">// method index in vtable</span>
  <span class="hl kwd">emit</span><span class="hl opt">(</span><span class="hl str">&quot;, _this&quot;</span><span class="hl opt">);</span>                      <span class="hl slc">// First method parameter</span>
  comma<span class="hl opt">++;</span>                              <span class="hl slc">// if method has params</span>
<span class="hl opt">}</span>
</code></pre>

<p>Ainsi, <code>int x = a.foo(10, 20)</code></p>

<pre><code class="hl c">⟹    <span class="hl kwb">int</span> x <span class="hl opt">=</span> <span class="hl kwd">_TOY_INVOKE</span><span class="hl opt">(</span><span class="hl kwb">int</span><span class="hl opt">,</span> a<span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">,</span> _this<span class="hl opt">,</span> <span class="hl num">10</span><span class="hl opt">,</span> <span class="hl num">20</span><span class="hl opt">);</span>
</code></pre>

<pre><code class="hl c">⟹    <span class="hl kwb">int</span> x <span class="hl opt">= ({</span> Object _this <span class="hl opt">= (</span>Object<span class="hl opt">)</span> a<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(!</span> _this<span class="hl opt">)</span> <span class="hl kwd">_toy_nullaccess</span><span class="hl opt">(</span><span class="hl str">&quot;zoo.c&quot;</span><span class="hl opt">,</span> <span class="hl num">40</span><span class="hl opt">);</span>
        <span class="hl opt">((</span><span class="hl kwb">int</span> <span class="hl opt">(*)()) (</span>_this<span class="hl opt">-&gt;</span>_instance_of<span class="hl opt">-&gt;</span>methods<span class="hl opt">[</span><span class="hl num">2</span><span class="hl opt">]))</span>
                                         <span class="hl opt">(</span>_this<span class="hl opt">,</span> <span class="hl num">10</span><span class="hl opt">,</span> <span class="hl num">20</span><span class="hl opt">);});</span>
</code></pre>
   <!-- ========== SLIDE ==========  (pseudo-slide to circumvent a bug in slidy.js)-->
   <div class="handout">
     
   </div>


    
    <script>
      hljs.initHighlighting();
    </script>
    

    
    <!--Maths -->
    <script>
      renderMathInElement(document.body);
    </script>
    
  </body>
</html>
